<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream Schedule</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/modern-screenshot/dist/modern-screenshot.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dom-to-image-more@3.1.0/dist/dom-to-image-more.min.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@1/index.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Improve html2canvas compatibility: force line-height and overflow for all children of #outerPaddingContainer */
        /* Only apply to timestamp containers */
        .timestamp-box {
            line-height: 1.2;
            overflow: hidden;
        }
        #outerPaddingContainer {
            background-color: var(--bg-primary);
        }
        body {
            font-family: 'Inter', sans-serif;
        }

        /* --- THEME DEFINITIONS --- */
        :root, .theme-twilight {
            --bg-primary: #111827;
            --bg-secondary: rgba(31, 41, 55, 0.5);
            --border-primary: rgba(55, 65, 81, 0.5);
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-muted: #6b7280;
            --header-gradient-start: #c084fc;
            --header-gradient-end: #67e8f9;
            --header-glow: rgba(192, 132, 252, 0.3);
            --today-accent: #a78bfa;
            --today-accent-bg: rgba(167, 139, 250, 0.2);
            --today-header: #67e8f9;
            --today-header-border: rgba(103, 232, 249, 0.3);
            --tomorrow-bg: rgba(124, 58, 237, 0.4);
            --tomorrow-border: rgba(139, 92, 246, 0.5);
            --tomorrow-accent-bg: rgba(167, 139, 250, 0.2);
            --tomorrow-text: #ddd6fe;
            --tomorrow-header: #6ee7b7;
            --tomorrow-header-border: rgba(110, 231, 183, 0.3);
            /* UI Controls */
            --input-bg: #374151;
            --input-border: #4b5563;
            --btn-active-bg: #9333ea;
            --btn-inactive-bg: #4b5563;
            --tab-active-bg: #581c87;
            --tab-active-text: #f0abfc;
        }

        .theme-sunrise {
            --bg-primary: #1c1917;
            --bg-secondary: rgba(41, 37, 36, 0.5);
            --border-primary: rgba(68, 64, 60, 0.5);
            --text-primary: #fff7ed;
            --text-secondary: #fed7aa;
            --text-muted: #fde68a;
            --header-gradient-start: #f97316;
            --header-gradient-end: #ef4444;
            --header-glow: rgba(249, 115, 22, 0.3);
            --today-accent: #fb923c;
            --today-accent-bg: rgba(251, 146, 60, 0.1);
            --today-header: #fb923c;
            --today-header-border: rgba(251, 146, 60, 0.3);
            --tomorrow-bg: rgba(239, 68, 68, 0.2);
            --tomorrow-border: rgba(239, 68, 68, 0.4);
            --tomorrow-accent-bg: rgba(248, 113, 113, 0.15);
            --tomorrow-text: #fca5a5;
            --tomorrow-header: #f87171;
            --tomorrow-header-border: rgba(248, 113, 113, 0.3);
            /* UI Controls */
            --input-bg: #292524;
            --input-border: #44403c;
            --btn-active-bg: #ea580c;
            --btn-inactive-bg: #57534e;
            --tab-active-bg: #431407;
            --tab-active-text: #fdba74;
        }
        
        .theme-forest {
            --bg-primary: #052e16; /* Darker Green for better contrast */
            --bg-secondary: rgba(22, 101, 52, 0.5);
            --border-primary: rgba(20, 83, 45, 0.5);
            --text-primary: #f0fdf4;
            --text-secondary: #bbf7d0;
            --text-muted: #86efac;
            --header-gradient-start: #fde047;
            --header-gradient-end: #bef264;
            --header-glow: rgba(253, 224, 71, 0.2);
            --today-accent: #fde047;
            --today-accent-bg: rgba(253, 224, 71, 0.1);
            --today-header: #bef264;
            --today-header-border: rgba(190, 242, 100, 0.3);
            --tomorrow-bg: rgba(132, 204, 22, 0.2);
            --tomorrow-border: rgba(132, 204, 22, 0.4);
            --tomorrow-accent-bg: rgba(234, 179, 8, 0.15);
            --tomorrow-text: #fde047;
            --tomorrow-header: #a3e635;
            --tomorrow-header-border: rgba(163, 230, 53, 0.3);
            /* UI Controls */
            --input-bg: #166534;
            --input-border: #15803d;
            --btn-active-bg: #ca8a04;
            --btn-inactive-bg: #15803d;
            --tab-active-bg: #f7fee7;
            --tab-active-text: #4d7c0f;
        }

        .theme-oceanic {
            --bg-primary: #0c2d48;
            --bg-secondary: rgba(20, 69, 107, 0.5);
            --border-primary: rgba(20, 69, 107, 0.5);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --header-gradient-start: #2dd4bf;
            --header-gradient-end: #7dd3fc;
            --header-glow: rgba(45, 212, 191, 0.3);
            --today-accent: #facc15;
            --today-accent-bg: rgba(250, 204, 21, 0.1);
            --today-header: #7dd3fc;
            --today-header-border: rgba(125, 211, 252, 0.3);
            --tomorrow-bg: rgba(20, 184, 166, 0.2);
            --tomorrow-border: rgba(20, 184, 166, 0.4);
            --tomorrow-accent-bg: rgba(20, 184, 166, 0.15);
            --tomorrow-text: #5eead4;
            --tomorrow-header: #2dd4bf;
            --tomorrow-header-border: rgba(45, 212, 191, 0.3);
            /* UI Controls */
            --input-bg: #1e40af;
            --input-border: #1d4ed8;
            --btn-active-bg: #0ea5e9;
            --btn-inactive-bg: #1e40af;
            --tab-active-bg: #e0f2fe;
            --tab-active-text: #0369a1;
        }

        .theme-cyberpunk {
            --bg-primary: #0a0a0a;
            --bg-secondary: rgba(23, 23, 23, 0.5);
            --border-primary: rgba(38, 38, 38, 0.5);
            --text-primary: #ffffff;
            --text-secondary: #e5e5e5;
            --text-muted: #a3a3a3;
            --header-gradient-start: #f472b6;
            --header-gradient-end: #38bdf8;
            --header-glow: rgba(244, 114, 182, 0.3);
            --today-accent: #fde047;
            --today-accent-bg: rgba(253, 224, 71, 0.1);
            --today-header: #f472b6;
            --today-header-border: rgba(244, 114, 182, 0.3);
            --tomorrow-bg: rgba(34, 211, 238, 0.2);
            --tomorrow-border: rgba(34, 211, 238, 0.4);
            --tomorrow-accent-bg: rgba(34, 211, 238, 0.15);
            --tomorrow-text: #67e8f9;
            --tomorrow-header: #22d3ee;
            --tomorrow-header-border: rgba(34, 211, 238, 0.3);
            /* UI Controls */
            --input-bg: #171717;
            --input-border: #262626;
            --btn-active-bg: #db2777;
            --btn-inactive-bg: #262626;
            --tab-active-bg: #fbcfe8;
            --tab-active-text: #9d174d;
        }

        .theme-pastel {
            --bg-primary: #2a2a3e;
            --bg-secondary: rgba(67, 56, 202, 0.2);
            --border-primary: rgba(99, 102, 241, 0.3);
            --text-primary: #e0e7ff;
            --text-secondary: #c7d2fe;
            --text-muted: #a5b4fc;
            --header-gradient-start: #f9a8d4;
            --header-gradient-end: #a5b4fc;
            --header-glow: rgba(249, 168, 212, 0.4);
            --today-accent: #f9a8d4;
            --today-accent-bg: rgba(249, 168, 212, 0.1);
            --today-header: #f9a8d4;
            --today-header-border: rgba(249, 168, 212, 0.5);
            --tomorrow-bg: rgba(165, 180, 252, 0.2);
            --tomorrow-border: rgba(165, 180, 252, 0.4);
            --tomorrow-accent-bg: rgba(165, 180, 252, 0.15);
            --tomorrow-text: #c7d2fe;
            --tomorrow-header: #a5b4fc;
            --tomorrow-header-border: rgba(165, 180, 252, 0.5);
            /* UI Controls */
            --input-bg: #312e81;
            --input-border: #4338ca;
            --btn-active-bg: #ec4899;
            --btn-inactive-bg: #6366f1;
            --tab-active-bg: #312e81;
            --tab-active-text: #fbcfe8;
        }

        .theme-arctic {
            --bg-primary: #0f172a;
            --bg-secondary: rgba(30, 58, 138, 0.3);
            --border-primary: rgba(59, 130, 246, 0.3);
            --text-primary: #f0f9ff;
            --text-secondary: #bae6fd;
            --text-muted: #7dd3fc;
            --header-gradient-start: #06b6d4;
            --header-gradient-end: #dbeafe;
            --header-glow: rgba(6, 182, 212, 0.4);
            --today-accent: #38bdf8;
            --today-accent-bg: rgba(56, 189, 248, 0.15);
            --today-header: #0ea5e9;
            --today-header-border: rgba(14, 165, 233, 0.4);
            --tomorrow-bg: rgba(147, 197, 253, 0.2);
            --tomorrow-border: rgba(147, 197, 253, 0.4);
            --tomorrow-accent-bg: rgba(224, 242, 254, 0.2);
            --tomorrow-text: #e0f2fe;
            --tomorrow-header: #7dd3fc;
            --tomorrow-header-border: rgba(125, 211, 252, 0.4);
            /* UI Controls */
            --input-bg: #1e3a8a;
            --input-border: #2563eb;
            --btn-active-bg: #0284c7;
            --btn-inactive-bg: #1e40af;
            --tab-active-bg: #dbeafe;
            --tab-active-text: #075985;
        }

        /* --- THEME-AWARE STYLES --- */
    .gradient-text { 
        color: var(--header-gradient-start); 
        text-shadow: 0 0 var(--title-glow-size, 20px) var(--header-glow),
                     0 0 var(--title-glow-size, 20px) var(--header-gradient-start);
        transition: text-shadow 0.3s ease;
    }
        .theme-btn.active { box-shadow: 0 0 0 3px var(--header-gradient-start); }
        
        .schedule-btn { background-color: var(--btn-inactive-bg); }
        .schedule-btn.active { background-color: var(--btn-active-bg); }
        
        .editor-tab { color: var(--text-secondary); }
        .editor-tab.active { background-color: var(--tab-active-bg); color: var(--tab-active-text); }
        
        .editor-input { background-color: var(--input-bg); border: 1px solid var(--input-border); color: var(--text-primary); }
        .editor-input::placeholder { color: var(--text-muted); }
        .editor-input:focus { outline: 2px solid var(--header-gradient-start); border-color: transparent; }

        /* Custom styles for range sliders */
        input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: #374151; border-radius: 9999px; outline: none; opacity: 0.7; transition: opacity .2s; }
        input[type="range"]:hover { opacity: 1; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: #818cf8; cursor: pointer; border-radius: 50%; }
        input[type="range"]::-moz-range-thumb { width: 20px; height: 20px; background: #818cf8; cursor: pointer; border-radius: 50%; }

        /* Glowing Panel Style */
        .glowing-panel {
            border: 1px solid var(--panel-border-color, rgba(255, 255, 255, 0.4));
            box-shadow: 0 0 var(--panel-glow-size, 40px) var(--panel-glow-color, rgba(255, 255, 255, 0.2)),
                        0 0 calc(var(--panel-glow-size, 40px) * 1.5) var(--panel-glow-color-secondary, rgba(255, 255, 255, 0.15)),
                        0 0 calc(var(--panel-glow-size, 40px) * 2) var(--panel-glow-color-tertiary, rgba(255, 255, 255, 0.1)),
                        inset 0 0 var(--panel-glow-size, 40px) var(--panel-glow-color-inset, rgba(255, 255, 255, 0.08));
            transition: box-shadow 0.3s ease, border 0.3s ease;
            position: relative;
        }

        /* Emoji Picker */
        #emojiPicker {
            display: none;
            position: absolute;
            bottom: 100%;
            right: 0;
            margin-bottom: 8px;
            z-index: 50;
            width: 320px;
        }

        /* Weekly Planner Styles */
        .week-day-card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 0.75rem;
            padding: 1rem;
            transition: all 0.3s ease;
        }
        .week-day-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .day-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            background-color: var(--today-accent-bg);
            color: var(--today-accent);
        }
        #weeklyPlannerModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            overflow-y: auto;
            padding: 2rem;
        }
        .modal-content {
            max-width: 90%;
            margin: 0 auto;
            background: var(--bg-primary);
            border-radius: 1rem;
            padding: 2rem;
        }
        .screenshot-preview {
            margin-bottom: 2rem;
            border: 2px solid var(--border-primary);
            border-radius: 0.5rem;
            overflow: hidden;
        }
    </style>
    <script src="editor-slots.js" defer></script>
</head>
<body class="bg-[var(--bg-primary)] text-[var(--text-primary)] antialiased transition-colors duration-300">

    <!-- Screenshot Generation Overlay -->
    <div id="screenshotOverlay" style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000;
        z-index: 99999;
        opacity: 0;
        transition: opacity 0.3s ease;
    ">
        <div style="
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            font-family: 'Inter', sans-serif;
        ">
            <div style="
                width: 60px;
                height: 60px;
                border: 4px solid rgba(255, 255, 255, 0.2);
                border-top-color: white;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin: 0 auto 20px;
            "></div>
            <h2 id="overlayTitle" style="font-size: 24px; margin-bottom: 10px;">Generating Screenshots</h2>
            <p id="overlayMessage" style="font-size: 16px; opacity: 0.8;">Please wait...</p>
        </div>
    </div>
    
    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>

    <!-- Main Layout Container -->
    <div class="flex" style="height: 100vh; overflow: hidden;">
        <!-- Left Column: Schedule Preview -->
        <div class="flex-1 overflow-auto flex justify-center" style="background-color: var(--bg-primary);">
            <!-- Container with max width -->
            <div class="w-full max-w-5xl p-8">
                <!-- Wrapper for Outer Padding -->
                <div id="outerPaddingContainer">
            <div id="masterPanel" class="glowing-panel rounded-2xl bg-transparent">
                <!-- Header/Title -->
                <header class="text-center mb-10">
                    <div class="bg-[var(--bg-secondary)] backdrop-blur-sm rounded-xl py-8 px-4 border border-[var(--border-primary)]">
                        <h1 id="channelNameDisplay" class="text-5xl sm:text-6xl font-extrabold tracking-tight gradient-text">
                            Audacious Gabe
                        </h1>
                        <a id="twitchLinkDisplay" href="https://www.twitch.tv/audaciousgabe" class="text-[var(--today-header)] hover:opacity-80 transition-all mt-3 text-lg inline-block" style="text-shadow: 0 0 var(--link-glow-size, 15px) var(--today-header);">
                            twitch.tv/audaciousgabe
                        </a>
                    </div>
                </header>

                <main class="space-y-12">
                     <!-- Today's Schedule -->
                    <div id="todaySection">
                        <h2 id="todayTitle" class="text-2xl font-bold text-[var(--today-header)] border-b-2 border-[var(--today-header-border)] pb-2 mb-6">
                            Today's Stream
                        </h2>
                        <!-- Container for the Normal Day Schedule -->
                        <div id="normalDayScheduleToday" class="space-y-4">
                            <!-- Time Slot 1 -->
                            <div class="bg-[var(--tomorrow-bg)] backdrop-blur-sm rounded-xl p-5 border border-[var(--tomorrow-border)] flex items-center gap-4">
                                <div class="bg-[var(--tomorrow-accent-bg)] text-[var(--tomorrow-text)] font-bold rounded-lg px-4 h-12 text-center w-48 flex items-center justify-center">
                                    <p>9:30 AM - 12:30 PM</p>
                                </div>
                                <div>
                                    <h3 id="todayNormalSlot1Title" class="text-xl font-semibold text-[var(--tomorrow-text)]">Morning Warmup</h3>
                                    <p id="todayNormalSlot1Desc" class="text-[var(--text-secondary)] mt-1">Clearing admin tasks, then jumping into chill development.</p>
                                </div>
                            </div>
                            <!-- Time Slot 2 -->
                            <div class="bg-[var(--tomorrow-bg)] backdrop-blur-sm rounded-xl p-5 border border-[var(--tomorrow-border)] flex items-center gap-4">
                                <div class="bg-[var(--tomorrow-accent-bg)] text-[var(--tomorrow-text)] font-bold rounded-lg px-4 py-3 text-center w-48 flex items-center justify-center">
                                    <p>1:00 PM - 4:00 PM</p>
                                </div>
                                <div>
                                    <h3 id="todayNormalSlot2Title" class="text-xl font-semibold text-[var(--tomorrow-text)]">Focused Development + Prototype Speedrun</h3>
                                    <p id="todayNormalSlot2Desc" class="text-[var(--text-secondary)] mt-1">Getting stuff done and making things happen ‚ú®üëè</p>
                                </div>
                            </div>
                            <!-- Time Slot 3 -->
                            <div class="bg-[var(--tomorrow-bg)] backdrop-blur-sm rounded-xl p-5 border border-[var(--tomorrow-border)] flex items-center gap-4">
                                <div class="bg-[var(--tomorrow-accent-bg)] text-[var(--tomorrow-text)] font-bold rounded-lg px-4 py-3 text-center w-48 flex items-center justify-center">
                                    <p>5:00 PM - 8:00 PM</p>
                                </div>
                                <div>
                                    <h3 id="todayNormalSlot3Title" class="text-xl font-semibold text-[var(--tomorrow-text)]">Greenlight Development</h3>
                                    <p id="todayNormalSlot3Desc" class="text-[var(--text-secondary)] mt-1">You picked it, now we're building it.</p>
                                </div>
                            </div>
                            <!-- Time Slot 4 -->
                            <div class="bg-[var(--tomorrow-bg)] backdrop-blur-sm rounded-xl p-5 border border-[var(--tomorrow-border)] flex items-center gap-4">
                                <div class="bg-[var(--tomorrow-accent-bg)] text-[var(--tomorrow-text)] font-bold rounded-lg px-4 py-3 text-center w-48 flex items-center justify-center">
                                    <p>9:00 PM - 12:00 AM</p>
                                </div>
                                <div>
                                    <h3 id="todayNormalSlot4Title" class="text-xl font-semibold text-[var(--tomorrow-text)]">Late Night Admin</h3>
                                    <p id="todayNormalSlot4Desc" class="text-[var(--text-secondary)] mt-1">Winding down with some chill development.</p>
                                </div>
                            </div>
                        </div>
                        <!-- Container for the Work Day Schedule (initially hidden) -->
                        <div id="workDayScheduleToday" class="space-y-4 hidden">
                             <!-- Work Block 1 -->
                            <div class="bg-[var(--tomorrow-bg)] backdrop-blur-sm rounded-xl p-5 border border-[var(--tomorrow-border)] flex items-center gap-4">
                                <div class="bg-[var(--tomorrow-accent-bg)] text-[var(--tomorrow-text)] font-bold rounded-lg px-4 py-3 text-center w-48 flex items-center justify-center">
                                    <p>9:30 AM - 12:30 PM</p>
                                </div>
                                <div>
                                    <h3 id="todayWorkSlot1Title" class="text-xl font-semibold text-[var(--tomorrow-text)]">Morning Warmup</h3>
                                    <p id="todayWorkSlot1Desc" class="text-[var(--text-secondary)] mt-1">Clearing admin tasks, then jumping into chill development.</p>
                                </div>
                            </div>
                            <!-- Work Block 2 -->
                            <div class="bg-[var(--tomorrow-bg)] backdrop-blur-sm rounded-xl p-5 border border-[var(--tomorrow-border)] flex items-center gap-4">
                                <div class="bg-[var(--tomorrow-accent-bg)] text-[var(--tomorrow-text)] font-bold rounded-lg px-4 py-3 text-center w-48 flex items-center justify-center">
                                    <p>12:30 PM - 3:30 PM</p>
                                </div>
                                <div>
                                    <h3 id="todayWorkSlot2Title" class="text-xl font-semibold text-[var(--tomorrow-text)]">Focused Development + Prototype Speedrun</h3>
                                    <p id="todayWorkSlot2Desc" class="text-[var(--text-secondary)] mt-1">Getting stuff done and making things happen ‚ú®üëè</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
                
                <div id="bottomContent">
                    <!-- Tomorrow's Schedule -->
                    <div class="mt-12">
                        <h2 id="tomorrowTitle" class="text-2xl font-bold text-[var(--tomorrow-header)] border-b-2 border-[var(--tomorrow-header-border)] pb-2 mb-6">
                            Tomorrow's Stream
                        </h2>
                         <!-- Container for the Normal Day Schedule (initially hidden) -->
                        <div id="normalDayScheduleTomorrow" class="space-y-4 hidden">
                            <!-- Time Slot 1 -->
                            <div class="bg-[var(--bg-secondary)] backdrop-blur-sm rounded-xl p-5 border border-[var(--border-primary)] flex items-center gap-4">
                                <div class="bg-[var(--today-accent-bg)] text-[var(--today-accent)] font-bold rounded-lg px-4 h-12 text-center w-48 flex items-center justify-center">
                                    <p>9:30 AM - 12:30 PM</p>
                                </div>
                                <div>
                                    <h3 id="tomorrowNormalSlot1Title" class="text-xl font-semibold text-[var(--text-primary)]">Morning Warmup</h3>
                                    <p id="tomorrowNormalSlot1Desc" class="text-[var(--text-secondary)] mt-1">Clearing admin tasks, then jumping into chill development.</p>
                                </div>
                            </div>
                            <!-- Time Slot 2 -->
                            <div class="bg-[var(--bg-secondary)] backdrop-blur-sm rounded-xl p-5 border border-[var(--border-primary)] flex items-center gap-4">
                                <div class="bg-[var(--today-accent-bg)] text-[var(--today-accent)] font-bold rounded-lg px-4 py-3 text-center w-48 flex items-center justify-center">
                                    <p>1:00 PM - 4:00 PM</p>
                                </div>
                                <div>
                                    <h3 id="tomorrowNormalSlot2Title" class="text-xl font-semibold text-[var(--text-primary)]">Focused Development + Prototype Speedrun</h3>
                                    <p id="tomorrowNormalSlot2Desc" class="text-[var(--text-secondary)] mt-1">Getting stuff done and making things happen ‚ú®üëè</p>
                                </div>
                            </div>
                            <!-- Time Slot 3 -->
                            <div class="bg-[var(--bg-secondary)] backdrop-blur-sm rounded-xl p-5 border border-[var(--border-primary)] flex items-center gap-4">
                                <div class="bg-[var(--today-accent-bg)] text-[var(--today-accent)] font-bold rounded-lg px-4 py-3 text-center w-48 flex items-center justify-center">
                                    <p>5:00 PM - 8:00 PM</p>
                                </div>
                                <div>
                                    <h3 id="tomorrowNormalSlot3Title" class="text-xl font-semibold text-[var(--text-primary)]">Greenlight Development</h3>
                                    <p id="tomorrowNormalSlot3Desc" class="text-[var(--text-secondary)] mt-1">You picked it, now we're building it.</p>
                                </div>
                            </div>
                            <!-- Time Slot 4 -->
                            <div class="bg-[var(--bg-secondary)] backdrop-blur-sm rounded-xl p-5 border border-[var(--border-primary)] flex items-center gap-4">
                                <div class="bg-[var(--today-accent-bg)] text-[var(--today-accent)] font-bold rounded-lg px-4 py-3 text-center w-48 flex items-center justify-center">
                                    <p>9:00 PM - 12:00 AM</p>
                                </div>
                                <div>
                                    <h3 id="tomorrowNormalSlot4Title" class="text-xl font-semibold text-[var(--text-primary)]">Late Night Admin</h3>
                                    <p id="tomorrowNormalSlot4Desc" class="text-[var(--text-secondary)] mt-1">Winding down with some chill development.</p>
                                </div>
                            </div>
                        </div>
                        <!-- Container for the Work Day Schedule -->
                        <div id="workDayScheduleTomorrow" class="space-y-4">
                            <!-- Work Block 1 -->
                            <div class="bg-[var(--bg-secondary)] backdrop-blur-sm rounded-xl p-5 border border-[var(--border-primary)] flex items-center gap-4">
                                <div class="bg-[var(--today-accent-bg)] text-[var(--today-accent)] font-bold rounded-lg px-4 py-3 text-center w-48 flex items-center justify-center">
                                    <p>9:30 AM - 12:30 PM</p>
                                </div>
                                <div>
                                    <h3 id="tomorrowWorkSlot1Title" class="text-xl font-semibold text-[var(--text-primary)]">Morning Warmup</h3>
                                    <p id="tomorrowWorkSlot1Desc" class="text-[var(--text-secondary)] mt-1">Clearing admin tasks, then jumping into chill development.</p>
                                </div>
                            </div>
                            <!-- Work Block 2 -->
                            <div class="bg-[var(--bg-secondary)] backdrop-blur-sm rounded-xl p-5 border border-[var(--border-primary)] flex items-center gap-4">
                                <div class="bg-[var(--today-accent-bg)] text-[var(--today-accent)] font-bold rounded-lg px-4 py-3 text-center w-48 flex items-center justify-center">
                                    <p>12:30 PM - 3:30 PM</p>
                                </div>
                                <div>
                                    <h3 id="tomorrowWorkSlot2Title" class="text-xl font-semibold text-[var(--text-primary)]">Focused Development + Prototype Speedrun</h3>
                                    <p id="tomorrowWorkSlot2Desc" class="text-[var(--text-secondary)] mt-1">Getting stuff done and making things happen ‚ú®üëè</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Footer -->
                    <footer class="text-center mt-6">
                        <p id="timezoneTextDisplay" class="text-[var(--text-muted)]">All times are in EST</p>
                    </footer>
                </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Settings Panel -->
        <div class="overflow-y-auto bg-[var(--bg-secondary)] border-l border-[var(--border-primary)]" style="height: 100vh; width: 850px;">
            <div class="p-6">
                <!-- Settings Header -->
                <h2 class="text-2xl font-bold text-center mb-6 text-[var(--text-primary)] sticky top-0 bg-[var(--bg-secondary)] py-4 border-b border-[var(--border-primary)] -mx-6 px-6">Settings Panel</h2>
                
                <!-- Theme Settings -->
                <div class="mb-6 p-4 bg-[var(--bg-primary)] rounded-xl border border-[var(--border-primary)]">
                    <h3 class="text-lg font-bold text-center mb-4 text-[var(--text-secondary)]">Theme Settings</h3>
                <div id="theme-buttons" class="flex flex-wrap justify-center gap-4">
                    <button data-theme="twilight" class="theme-btn active bg-purple-600 text-white font-bold py-2 px-4 rounded-lg transition-all hover:scale-105">Twilight</button>
                    <button data-theme="sunrise" class="theme-btn bg-orange-500 text-white font-bold py-2 px-4 rounded-lg transition-all hover:scale-105">Sunrise</button>
                    <button data-theme="forest" class="theme-btn bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-all hover:scale-105">Forest</button>
                    <button data-theme="oceanic" class="theme-btn bg-blue-500 text-white font-bold py-2 px-4 rounded-lg transition-all hover:scale-105">Oceanic</button>
                    <button data-theme="cyberpunk" class="theme-btn bg-pink-500 text-white font-bold py-2 px-4 rounded-lg transition-all hover:scale-105">Cyberpunk</button>
                    <button data-theme="pastel" class="theme-btn bg-indigo-300 text-indigo-900 font-bold py-2 px-4 rounded-lg transition-all hover:scale-105">Pastel</button>
                    <button data-theme="arctic" class="theme-btn bg-cyan-400 text-slate-900 font-bold py-2 px-4 rounded-lg transition-all hover:scale-105">Arctic</button>
                </div>
            </div>

                <!-- Schedule Settings -->
                <div class="mb-6 p-4 bg-[var(--bg-primary)] rounded-xl border border-[var(--border-primary)]">
                    <h3 class="text-lg font-bold text-center mb-4 text-[var(--text-secondary)]">Schedule Settings</h3>
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- Today's Settings -->
                        <div class="text-center">
                            <label class="block mb-3 text-sm font-medium text-[var(--text-secondary)]">Today's Schedule Type</label>
                            <div class="flex justify-center gap-4">
                                <button id="setNormalDayToday" class="schedule-btn active text-white font-bold py-2 px-6 rounded-lg transition-transform hover:scale-105">Normal</button>
                                <button id="setWorkDayToday" class="schedule-btn text-white font-bold py-2 px-6 rounded-lg transition-transform hover:scale-105">Work</button>
                            </div>
                        </div>
                        <!-- Tomorrow's Settings -->
                        <div class="text-center">
                            <label class="block mb-3 text-sm font-medium text-[var(--text-secondary)]">Tomorrow's Schedule Type</label>
                            <div class="flex justify-center gap-4">
                                <button id="setNormalDayTomorrow" class="schedule-btn text-white font-bold py-2 px-6 rounded-lg transition-transform hover:scale-105">Normal</button>
                                <button id="setWorkDayTomorrow" class="schedule-btn active text-white font-bold py-2 px-6 rounded-lg transition-transform hover:scale-105">Work</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Panel Scope Setting (moved from separate section) -->
                    <div class="pt-4 border-t border-[var(--border-primary)]">
                        <div class="text-center">
                            <label class="block mb-3 text-sm font-medium text-[var(--text-secondary)]">Export Scope</label>
                            <div class="flex justify-center items-center gap-4">
                                <span class="text-sm font-medium text-[var(--text-secondary)]">Today Only</span>
                                <label for="panelScopeToggle" class="relative inline-flex items-center cursor-pointer">
                                  <input type="checkbox" value="" id="panelScopeToggle" class="sr-only peer" checked>
                                  <div class="w-11 h-6 bg-[var(--btn-inactive-bg)] rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[var(--btn-active-bg)]"></div>
                                </label>
                                <span class="text-sm font-medium text-[var(--text-secondary)]">Full Schedule</span>
                            </div>
                            <p class="text-xs text-[var(--text-muted)] mt-2">Choose what to include when exporting the image</p>
                        </div>
                    </div>
                </div>
            </div>

                <!-- Content Editor -->
                <div class="mb-6 p-4 bg-[var(--bg-primary)] rounded-xl border border-[var(--border-primary)]">
                    <h3 class="text-lg font-bold text-center mb-4 text-[var(--text-secondary)]">Editor</h3>
                
                <!-- Global Settings -->
                <div class="mb-6">
                    <h4 class="text-lg font-semibold mb-4 text-[var(--text-secondary)]">Global Settings</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-[var(--text-secondary)] mb-1">Channel Name</label>
                            <input type="text" id="channelNameInput" class="editor-input w-full rounded-md p-2" value="Audacious Gabe">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-[var(--text-secondary)] mb-1">Twitch Channel Link</label>
                            <input type="text" id="twitchLinkInput" class="editor-input w-full rounded-md p-2" value="https://www.twitch.tv/audaciousgabe">
                        </div>
                    </div>
                </div>
                
                <!-- Editor Tabs -->
                <div class="flex justify-center border-b border-[var(--border-primary)] mb-6">
                    <button id="editTodayTab" class="editor-tab active py-2 px-6 font-semibold rounded-t-lg">Edit Today</button>
                    <button id="editTomorrowTab" class="editor-tab py-2 px-6 font-semibold rounded-t-lg">Edit Tomorrow</button>
                </div>

                <!-- Today's Editor Panel -->
                <div id="todayEditor">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-[var(--text-secondary)] mb-1">Main Title</label>
                            <input type="text" id="todayTitleInput" class="editor-input w-full rounded-md p-2">
                        </div>
                        <hr class="border-[var(--border-primary)]">
                        <h4 class="font-semibold text-[var(--today-accent)]">Normal Day Schedule</h4>
                        <!-- Normal Day Inputs -->
                        <div id="todayNormalEditorContainer" class="space-y-2">
                            <!-- Dynamic slots will be inserted here -->
                        </div>
                        <hr class="border-[var(--border-primary)]">
                        <h4 class="font-semibold text-[var(--today-accent)]">Work Day Schedule</h4>
                        <!-- Work Day Inputs -->
                        <div id="todayWorkEditorContainer" class="space-y-2">
                            <!-- Dynamic slots will be inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Tomorrow's Editor Panel (hidden by default) -->
                <div id="tomorrowEditor" class="hidden">
                     <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-[var(--text-secondary)] mb-1">Main Title</label>
                            <input type="text" id="tomorrowTitleInput" class="editor-input w-full rounded-md p-2">
                        </div>
                        <hr class="border-[var(--border-primary)]">
                        <h4 class="font-semibold text-[var(--tomorrow-text)]">Normal Day Schedule</h4>
                        <!-- Normal Day Inputs -->
                        <div id="tomorrowNormalEditorContainer" class="space-y-2">
                            <!-- Dynamic slots will be inserted here -->
                        </div>
                        <hr class="border-[var(--border-primary)]">
                        <h4 class="font-semibold text-[var(--tomorrow-text)]">Work Day Schedule</h4>
                        <!-- Work Day Inputs -->
                        <div id="tomorrowWorkEditorContainer" class="space-y-2">
                            <!-- Dynamic slots will be inserted here -->
                        </div>
                    </div>
                </div>
                
                <!-- Timezone Setting (at bottom to match layout) -->
                <div class="mt-6 pt-6 border-t border-[var(--border-primary)]">
                    <div>
                        <label class="block text-sm font-medium text-[var(--text-secondary)] mb-1">Timezone Text</label>
                        <input type="text" id="timezoneTextInput" class="editor-input w-full rounded-md p-2" value="All times are in EST">
                    </div>
                </div>
            </div>

                <!-- Layout Settings -->
                <div class="mb-6 p-4 bg-[var(--bg-primary)] rounded-xl border border-[var(--border-primary)]">
                    <h3 class="text-lg font-bold text-center mb-4 text-[var(--text-secondary)]">Layout Customization</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                    <!-- Outer Padding -->
                    <div class="md:col-span-2">
                        <h4 class="font-semibold text-center mb-4 text-[var(--text-secondary)]">Outer Padding</h4>
                    </div>
                    <div>
                        <label for="outerPaddingTop" class="block mb-2 text-sm font-medium text-[var(--text-secondary)]">Top</label>
                        <div class="flex items-center gap-4">
                            <input id="outerPaddingTop" type="range" min="0" max="128" value="32" class="w-full">
                            <span id="outerPaddingTopValue" class="text-sm text-[var(--today-header)] font-mono w-10 text-right">32px</span>
                        </div>
                    </div>
                    <div>
                        <label for="outerPaddingBottom" class="block mb-2 text-sm font-medium text-[var(--text-secondary)]">Bottom</label>
                         <div class="flex items-center gap-4">
                            <input id="outerPaddingBottom" type="range" min="0" max="128" value="32" class="w-full">
                            <span id="outerPaddingBottomValue" class="text-sm text-[var(--today-header)] font-mono w-10 text-right">32px</span>
                        </div>
                    </div>
                    <div>
                        <label for="outerPaddingLeft" class="block mb-2 text-sm font-medium text-[var(--text-secondary)]">Left</label>
                         <div class="flex items-center gap-4">
                            <input id="outerPaddingLeft" type="range" min="0" max="128" value="32" class="w-full">
                            <span id="outerPaddingLeftValue" class="text-sm text-[var(--today-header)] font-mono w-10 text-right">32px</span>
                        </div>
                    </div>
                    <div>
                        <label for="outerPaddingRight" class="block mb-2 text-sm font-medium text-[var(--text-secondary)]">Right</label>
                         <div class="flex items-center gap-4">
                            <input id="outerPaddingRight" type="range" min="0" max="128" value="32" class="w-full">
                            <span id="outerPaddingRightValue" class="text-sm text-[var(--today-header)] font-mono w-10 text-right">32px</span>
                        </div>
                    </div>
                    <!-- Inner Padding -->
                     <div class="md:col-span-2 pt-4 mt-4 border-t border-[var(--border-primary)]">
                        <h4 class="font-semibold text-center mb-4 text-[var(--text-secondary)]">Inner Padding</h4>
                    </div>
                     <div>
                        <label for="innerPaddingTop" class="block mb-2 text-sm font-medium text-[var(--text-secondary)]">Top</label>
                        <div class="flex items-center gap-4">
                            <input id="innerPaddingTop" type="range" min="0" max="128" value="32" class="w-full">
                            <span id="innerPaddingTopValue" class="text-sm text-[var(--today-header)] font-mono w-10 text-right">32px</span>
                        </div>
                    </div>
                    <div>
                        <label for="innerPaddingBottom" class="block mb-2 text-sm font-medium text-[var(--text-secondary)]">Bottom</label>
                         <div class="flex items-center gap-4">
                            <input id="innerPaddingBottom" type="range" min="0" max="128" value="32" class="w-full">
                            <span id="innerPaddingBottomValue" class="text-sm text-[var(--today-header)] font-mono w-10 text-right">32px</span>
                        </div>
                    </div>
                    <div>
                        <label for="innerPaddingLeft" class="block mb-2 text-sm font-medium text-[var(--text-secondary)]">Left</label>
                         <div class="flex items-center gap-4">
                            <input id="innerPaddingLeft" type="range" min="0" max="128" value="32" class="w-full">
                            <span id="innerPaddingLeftValue" class="text-sm text-[var(--today-header)] font-mono w-10 text-right">32px</span>
                        </div>
                    </div>
                    <div>
                        <label for="innerPaddingRight" class="block mb-2 text-sm font-medium text-[var(--text-secondary)]">Right</label>
                         <div class="flex items-center gap-4">
                            <input id="innerPaddingRight" type="range" min="0" max="128" value="32" class="w-full">
                            <span id="innerPaddingRightValue" class="text-sm text-[var(--today-header)] font-mono w-10 text-right">32px</span>
                        </div>
                    </div>
                    <!-- Glow Customization -->
                    <div class="md:col-span-2 pt-4 mt-4 border-t border-[var(--border-primary)]">
                        <h4 class="font-semibold text-center mb-4 text-[var(--text-secondary)]">Glow Effects</h4>
                    </div>
                    <div>
                        <label for="titleGlowSize" class="block mb-2 text-sm font-medium text-[var(--text-secondary)]">Title Glow</label>
                        <div class="flex items-center gap-4">
                            <input id="titleGlowSize" type="range" min="0" max="60" value="8" class="w-full">
                            <span id="titleGlowSizeValue" class="text-sm text-[var(--today-header)] font-mono w-10 text-right">8px</span>
                        </div>
                    </div>
                    <div>
                        <label for="linkGlowSize" class="block mb-2 text-sm font-medium text-[var(--text-secondary)]">Link Glow</label>
                        <div class="flex items-center gap-4">
                            <input id="linkGlowSize" type="range" min="0" max="40" value="15" class="w-full">
                            <span id="linkGlowSizeValue" class="text-sm text-[var(--today-header)] font-mono w-10 text-right">15px</span>
                        </div>
                    </div>
                    <div>
                        <label for="panelGlowSize" class="block mb-2 text-sm font-medium text-[var(--text-secondary)]">Panel Glow</label>
                        <div class="flex items-center gap-4">
                            <input id="panelGlowSize" type="range" min="0" max="120" value="50" class="w-full">
                            <span id="panelGlowSizeValue" class="text-sm text-[var(--today-header)] font-mono w-10 text-right">50px</span>
                        </div>
                    </div>
                    <div>
                        <label for="glowIntensity" class="block mb-2 text-sm font-medium text-[var(--text-secondary)]">Glow Intensity</label>
                        <div class="flex items-center gap-4">
                            <input id="glowIntensity" type="range" min="0" max="100" value="50" class="w-full">
                            <span id="glowIntensityValue" class="text-sm text-[var(--today-header)] font-mono w-10 text-right">50%</span>
                        </div>
                    </div>
                </div>
            </div>

                <!-- Discord Message Generator -->
                <div class="mb-6 p-4 bg-[var(--bg-primary)] rounded-xl border border-[var(--border-primary)]">
                    <h3 class="text-lg font-bold text-center mb-4 text-[var(--text-secondary)]">Discord Message Generator</h3>
                <div class="mb-4 relative">
                    <label for="discordTitleInput" class="block text-sm font-medium text-[var(--text-secondary)] mb-2">Announcement Title</label>
                    <div class="flex items-center gap-2">
                        <input type="text" id="discordTitleInput" class="editor-input w-full rounded-md p-2" value="Doubling our Usual Hours! ‚ú®üëè">
                        <button id="emojiBtn" class="schedule-btn active text-white font-bold py-2 px-4 rounded-lg" title="Insert emoji">üòÄ</button>
                    </div>
                    <emoji-picker id="emojiPicker" theme="dark"></emoji-picker>
                </div>
                
                <!-- Message Template Editor -->
                <div class="mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <label for="discordTemplateInput" class="block text-sm font-medium text-[var(--text-secondary)]">Message Template</label>
                        <button id="resetTemplateBtn" class="text-xs text-[var(--text-muted)] hover:text-[var(--text-secondary)] transition-colors">Reset to Default</button>
                    </div>
                    <textarea id="discordTemplateInput" class="editor-input w-full h-48 rounded-md p-2 resize-none font-mono text-sm" placeholder="Use placeholders: [title], [today], [tomorrow], [link], [timezone]"></textarea>
                    <div class="mt-2 text-xs text-[var(--text-muted)]">
                        <div class="font-semibold mb-1">Available placeholders:</div>
                        <div class="grid grid-cols-2 gap-1">
                            <span><code class="bg-[var(--input-bg)] px-1 rounded">[title]</code> - Your announcement title</span>
                            <span><code class="bg-[var(--input-bg)] px-1 rounded">[today]</code> - Today's schedule times</span>
                            <span><code class="bg-[var(--input-bg)] px-1 rounded">[tomorrow]</code> - Tomorrow's schedule times</span>
                            <span><code class="bg-[var(--input-bg)] px-1 rounded">[link]</code> - Your Twitch channel link</span>
                            <span><code class="bg-[var(--input-bg)] px-1 rounded">[timezone]</code> - Dynamic timezone note</span>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-[var(--text-secondary)] mb-2">Timestamp Format</label>
                        <select id="timestampFormat" class="editor-input w-full rounded-md p-2">
                            <option value="t">Short Time (e.g., 10:30 AM)</option>
                            <option value="T">Long Time (e.g., 10:30:00 AM)</option>
                            <option value="d">Short Date (e.g., 08/23/2025)</option>
                            <option value="D">Long Date (e.g., August 23, 2025)</option>
                            <option value="f">Short Date/Time (e.g., August 23, 2025 10:30 AM)</option>
                            <option value="F">Long Date/Time (e.g., Saturday, August 23, 2025 10:30 AM)</option>
                            <option value="R">Relative Time (e.g., in 2 hours)</option>
                        </select>
                    </div>
                    <div class="flex items-end justify-center">
                         <div class="flex items-center gap-4">
                            <span class="text-sm font-medium text-[var(--text-secondary)]">Default</span>
                            <label for="useTimestampsToggle" class="relative inline-flex items-center cursor-pointer">
                              <input type="checkbox" value="" id="useTimestampsToggle" class="sr-only peer" checked>
                              <div class="w-11 h-6 bg-[var(--btn-inactive-bg)] rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[var(--btn-active-bg)]"></div>
                            </label>
                            <span class="text-sm font-medium text-[var(--text-secondary)]">Timestamps</span>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-[var(--text-secondary)] mb-2">Preview</label>
                    <textarea id="discordMessageOutput" readonly class="editor-input w-full h-64 rounded-md p-2 resize-none"></textarea>
                </div>
                    <button id="copyMessageBtn" class="schedule-btn active mt-4 w-full text-white font-bold py-3 px-6 rounded-lg transition-transform hover:scale-105">Copy Message</button>
                </div>

                <!-- Save Settings -->
                <div class="mb-6 p-4 bg-[var(--bg-primary)] rounded-xl border border-[var(--border-primary)]">
                    <h3 class="text-lg font-bold text-center mb-4 text-[var(--text-secondary)]">Save Configuration</h3>
                    <button id="saveAllSettingsBtn" class="schedule-btn active w-full text-white font-bold py-3 px-6 rounded-lg transition-transform hover:scale-105">
                        üíæ Save All Settings
                    </button>
                    <p id="saveStatusMessage" class="text-center text-sm mt-2 text-[var(--text-muted)] hidden"></p>
                </div>

                <!-- Export Schedule -->
                <div class="mb-6 p-4 bg-[var(--bg-primary)] rounded-xl border border-[var(--border-primary)]">
                    <h3 class="text-lg font-bold text-center mb-4 text-[var(--text-secondary)]">Export Schedule</h3>
                    <button id="exportBtn" class="schedule-btn active w-full text-white font-bold py-3 px-6 rounded-lg transition-transform hover:scale-105">
                        üì∏ Download Schedule as PNG
                    </button>
                </div>

                <!-- Weekly Planner -->
                <div class="mb-6 p-4 bg-[var(--bg-primary)] rounded-xl border border-[var(--border-primary)]">
                    <h3 class="text-lg font-bold text-center mb-4 text-[var(--text-secondary)]">Weekly Schedule Planner</h3>
                <p class="text-sm text-center text-[var(--text-muted)] mb-6">Plan your entire week and generate individual schedule images for each day</p>
                
                <!-- Days Grid - Max 3 days per row -->
                <div id="weekDayCards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-6"></div>
                
                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-3">
                    <button id="generateWeeklyScreenshots" class="schedule-btn active flex-1 text-white font-bold py-3 px-6 rounded-lg transition-transform hover:scale-105">
                        üìÖ Generate Week Screenshots
                    </button>
                    <button id="previewWeeklySchedule" class="schedule-btn active flex-1 text-white font-bold py-3 px-6 rounded-lg transition-transform hover:scale-105">
                        üëÅÔ∏è Preview All Days
                    </button>
                </div>
            </div>

            <!-- Weekly Preview Modal -->
            <div id="weeklyPlannerModal">
                <div class="modal-content">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-[var(--text-primary)]">Weekly Schedule Preview</h2>
                        <button id="closeWeeklyModal" class="text-3xl text-[var(--text-muted)] hover:text-[var(--text-primary)]">&times;</button>
                    </div>
                    <div id="weeklyPreviewContainer" class="space-y-8">
                        <!-- Preview content will be generated here -->
                    </div>
                    <div class="mt-6 flex justify-center">
                        <button id="downloadAllWeekly" class="schedule-btn active text-white font-bold py-3 px-8 rounded-lg transition-transform hover:scale-105">
                            üíæ Download All as ZIP
                        </button>
                    </div>
                </div>
            </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Load Configuration from Server ---
            async function loadConfigFromServer() {
                try {
                    const response = await fetch('http://127.0.0.1:5555/api/config');
                    if (response.ok) {
                        const config = await response.json();
                        
                        // Apply channel configuration
                        if (config.channel) {
                            const channelNameDisplay = document.getElementById('channelNameDisplay');
                            const channelNameInput = document.getElementById('channelNameInput');
                            const twitchLinkDisplay = document.getElementById('twitchLinkDisplay');
                            const twitchLinkInput = document.getElementById('twitchLinkInput');
                            
                            if (config.channel.name) {
                                channelNameDisplay.textContent = config.channel.name;
                                channelNameInput.value = config.channel.name;
                            }
                            
                            if (config.channel.link) {
                                const url = config.channel.link;
                                twitchLinkDisplay.href = url;
                                twitchLinkInput.value = url;
                                // Extract username from URL for display text
                                const match = url.match(/twitch\.tv\/([^/?]+)/);
                                if (match) {
                                    twitchLinkDisplay.textContent = `twitch.tv/${match[1]}`;
                                } else {
                                    twitchLinkDisplay.textContent = url;
                                }
                            }
                        }
                        
                        // Apply theme
                        if (config.theme) {
                            document.body.className = `bg-[var(--bg-primary)] text-[var(--text-primary)] antialiased transition-colors duration-300 theme-${config.theme}`;
                            // Update theme button selection
                            const themeButtons = document.querySelectorAll('.theme-btn');
                            themeButtons.forEach(btn => {
                                if (btn.dataset.theme === config.theme) {
                                    btn.classList.add('active');
                                } else {
                                    btn.classList.remove('active');
                                }
                            });
                        }
                        
                        // Apply schedule types
                        if (config.schedule) {
                            if (config.schedule.today && config.schedule.today.type) {
                                if (config.schedule.today.type === 'work') {
                                    document.getElementById('setWorkDayToday').click();
                                } else {
                                    document.getElementById('setNormalDayToday').click();
                                }
                            }
                            
                            if (config.schedule.tomorrow && config.schedule.tomorrow.type) {
                                if (config.schedule.tomorrow.type === 'work') {
                                    document.getElementById('setWorkDayTomorrow').click();
                                } else {
                                    document.getElementById('setNormalDayTomorrow').click();
                                }
                            }
                        }
                        
                        // Apply export scope
                        if (config.exportScope) {
                            const panelScopeToggle = document.getElementById('panelScopeToggle');
                            if (panelScopeToggle) {
                                panelScopeToggle.checked = (config.exportScope === 'full');
                                panelScopeToggle.dispatchEvent(new Event('change'));
                            }
                        }
                        
                        // Apply layout settings
                        if (config.layout) {
                            // Apply outer padding
                            if (config.layout.outerPadding) {
                                const outerPaddingTop = document.getElementById('outerPaddingTop');
                                const outerPaddingBottom = document.getElementById('outerPaddingBottom');
                                const outerPaddingLeft = document.getElementById('outerPaddingLeft');
                                const outerPaddingRight = document.getElementById('outerPaddingRight');
                                
                                if (outerPaddingTop && config.layout.outerPadding.top !== undefined) {
                                    outerPaddingTop.value = config.layout.outerPadding.top;
                                    outerPaddingTop.dispatchEvent(new Event('input'));
                                }
                                if (outerPaddingBottom && config.layout.outerPadding.bottom !== undefined) {
                                    outerPaddingBottom.value = config.layout.outerPadding.bottom;
                                    outerPaddingBottom.dispatchEvent(new Event('input'));
                                }
                                if (outerPaddingLeft && config.layout.outerPadding.left !== undefined) {
                                    outerPaddingLeft.value = config.layout.outerPadding.left;
                                    outerPaddingLeft.dispatchEvent(new Event('input'));
                                }
                                if (outerPaddingRight && config.layout.outerPadding.right !== undefined) {
                                    outerPaddingRight.value = config.layout.outerPadding.right;
                                    outerPaddingRight.dispatchEvent(new Event('input'));
                                }
                            }
                            
                            // Apply inner padding
                            if (config.layout.innerPadding) {
                                const innerPaddingTop = document.getElementById('innerPaddingTop');
                                const innerPaddingBottom = document.getElementById('innerPaddingBottom');
                                const innerPaddingLeft = document.getElementById('innerPaddingLeft');
                                const innerPaddingRight = document.getElementById('innerPaddingRight');
                                
                                if (innerPaddingTop && config.layout.innerPadding.top !== undefined) {
                                    innerPaddingTop.value = config.layout.innerPadding.top;
                                    innerPaddingTop.dispatchEvent(new Event('input'));
                                }
                                if (innerPaddingBottom && config.layout.innerPadding.bottom !== undefined) {
                                    innerPaddingBottom.value = config.layout.innerPadding.bottom;
                                    innerPaddingBottom.dispatchEvent(new Event('input'));
                                }
                                if (innerPaddingLeft && config.layout.innerPadding.left !== undefined) {
                                    innerPaddingLeft.value = config.layout.innerPadding.left;
                                    innerPaddingLeft.dispatchEvent(new Event('input'));
                                }
                                if (innerPaddingRight && config.layout.innerPadding.right !== undefined) {
                                    innerPaddingRight.value = config.layout.innerPadding.right;
                                    innerPaddingRight.dispatchEvent(new Event('input'));
                                }
                            }
                        }
                        
                        // Apply glow effects
                        if (config.glowEffects) {
                            const titleGlowSize = document.getElementById('titleGlowSize');
                            const linkGlowSize = document.getElementById('linkGlowSize');
                            const panelGlowSize = document.getElementById('panelGlowSize');
                            const glowIntensity = document.getElementById('glowIntensity');
                            
                            if (titleGlowSize && config.glowEffects.titleGlowSize !== undefined) {
                                titleGlowSize.value = config.glowEffects.titleGlowSize;
                                titleGlowSize.dispatchEvent(new Event('input'));
                            }
                            if (linkGlowSize && config.glowEffects.linkGlowSize !== undefined) {
                                linkGlowSize.value = config.glowEffects.linkGlowSize;
                                linkGlowSize.dispatchEvent(new Event('input'));
                            }
                            if (panelGlowSize && config.glowEffects.panelGlowSize !== undefined) {
                                panelGlowSize.value = config.glowEffects.panelGlowSize;
                                panelGlowSize.dispatchEvent(new Event('input'));
                            }
                            if (glowIntensity && config.glowEffects.glowIntensity !== undefined) {
                                glowIntensity.value = config.glowEffects.glowIntensity;
                                glowIntensity.dispatchEvent(new Event('input'));
                            }
                        }
                        
                        // Apply timezone text
                        if (config.timezoneText) {
                            const timezoneTextInput = document.getElementById('timezoneTextInput');
                            const timezoneTextDisplay = document.getElementById('timezoneTextDisplay');
                            if (timezoneTextInput) {
                                timezoneTextInput.value = config.timezoneText;
                                if (timezoneTextDisplay) {
                                    timezoneTextDisplay.textContent = config.timezoneText;
                                }
                            }
                        }
                        
                        // Apply Discord message generator settings
                        if (config.discord) {
                            const discordTitleInput = document.getElementById('discordTitleInput');
                            const discordTemplateInput = document.getElementById('discordTemplateInput');
                            const useTimestampsToggle = document.getElementById('useTimestampsToggle');
                            const timestampFormatSelect = document.getElementById('timestampFormat');
                            
                            if (discordTitleInput && config.discord.title !== undefined) {
                                discordTitleInput.value = config.discord.title;
                            }
                            
                            if (discordTemplateInput && config.discord.template !== undefined) {
                                discordTemplateInput.value = config.discord.template;
                            }
                            
                            if (useTimestampsToggle && config.discord.useTimestamps !== undefined) {
                                useTimestampsToggle.checked = config.discord.useTimestamps;
                            }
                            
                            if (timestampFormatSelect && config.discord.timestampFormat !== undefined) {
                                timestampFormatSelect.value = config.discord.timestampFormat;
                            }
                            
                            // Regenerate the Discord message with loaded settings
                            if (typeof generateDiscordMessage === 'function') {
                                // Delay to ensure all elements are ready
                                setTimeout(() => {
                                    generateDiscordMessage();
                                }, 100);
                            }
                        }
                        
                        console.log('Configuration loaded from server:', config);
                    } else {
                        console.log('Server not available, using default configuration');
                    }
                } catch (error) {
                    console.log('Failed to load config from server:', error);
                    console.log('Using default configuration');
                }
            }
            
            // Try to load configuration from server
            loadConfigFromServer();
            
            // --- Date Setup ---
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const dateOptions = { month: 'short', day: 'numeric' };
            
            const todayString = today.toLocaleDateString('en-US', dateOptions);
            const tomorrowString = tomorrow.toLocaleDateString('en-US', dateOptions);

            const todayTitleEl = document.getElementById('todayTitle');
            const tomorrowTitleEl = document.getElementById('tomorrowTitle');
            
            const todayTitleText = `Today's Stream &bull; ${todayString}`;
            const tomorrowTitleText = `Tomorrow's Stream &bull; ${tomorrowString}`;

            todayTitleEl.innerHTML = todayTitleText;
            tomorrowTitleEl.innerHTML = tomorrowTitleText;


            // --- Function to save config to server ---
            async function saveConfigToServer(updates) {
                try {
                    const response = await fetch('http://localhost:5555/api/config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updates)
                    });
                    
                    if (response.ok) {
                        console.log('Configuration saved to server');
                    } else {
                        console.error('Failed to save configuration');
                    }
                } catch (error) {
                    console.error('Error saving configuration:', error);
                }
            }
            
            // --- Theme Controls ---
            const themeButtonsContainer = document.getElementById('theme-buttons');
            themeButtonsContainer.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    const theme = e.target.dataset.theme;
                    document.body.className = `bg-[var(--bg-primary)] text-[var(--text-primary)] antialiased transition-colors duration-300 theme-${theme}`;
                    
                    // Update active button style
                    themeButtonsContainer.querySelector('.active').classList.remove('active');
                    e.target.classList.add('active');
                }
            });

            // --- Panel Scope Toggle ---
            const panelScopeToggle = document.getElementById('panelScopeToggle');
            const masterPanel = document.getElementById('masterPanel');
            const bottomContent = document.getElementById('bottomContent');

            panelScopeToggle.addEventListener('change', () => {
                if (panelScopeToggle.checked) {
                    // Full Scope: Append bottom content to master panel
                    masterPanel.appendChild(bottomContent);
                } else {
                    // Today Only: Append bottom content after master panel's parent
                    masterPanel.parentNode.insertBefore(bottomContent, masterPanel.nextSibling);
                }
            });

            // --- Schedule Type Controls ---
            const scheduleControls = {
                today: {
                    normalBtn: document.getElementById('setNormalDayToday'),
                    workBtn: document.getElementById('setWorkDayToday'),
                    normalSchedule: document.getElementById('normalDayScheduleToday'),
                    workSchedule: document.getElementById('workDayScheduleToday'),
                },
                tomorrow: {
                    normalBtn: document.getElementById('setNormalDayTomorrow'),
                    workBtn: document.getElementById('setWorkDayTomorrow'),
                    normalSchedule: document.getElementById('normalDayScheduleTomorrow'),
                    workSchedule: document.getElementById('workDayScheduleTomorrow'),
                }
            };
            
            // --- Discord Message Generator Variables (declared early to avoid reference errors) ---
            const discordMessageOutput = document.getElementById('discordMessageOutput');
            const copyMessageBtn = document.getElementById('copyMessageBtn');
            const useTimestampsToggle = document.getElementById('useTimestampsToggle');
            const timestampFormatSelect = document.getElementById('timestampFormat');
            const discordTitleInput = document.getElementById('discordTitleInput');
            const discordTemplateInput = document.getElementById('discordTemplateInput');
            const resetTemplateBtn = document.getElementById('resetTemplateBtn');
            
            // Default Discord message template
            const defaultTemplate = `@Twitch Enjoyers : [title]

I will be streaming on Twitch \`\`Today\`\` from:

[today]

\`\`Tomorrow\`\` I'll be streaming from:

[tomorrow]

[timezone]

[link]`;
            
            // Initialize template with default if empty
            if (discordTemplateInput) {
                discordTemplateInput.value = defaultTemplate;
            }
            
            // --- Discord Message Generator Functions ---
            function getTimestamp(date, hours, minutes) {
                const d = new Date(date);
                d.setHours(hours, minutes, 0, 0);
                return Math.floor(d.getTime() / 1000);
            }

            // Helper function to parse time string to hours and minutes
            function parseTimeString(timeStr) {
                const match = timeStr.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
                if (!match) return null;
                
                let hours = parseInt(match[1]);
                const minutes = parseInt(match[2]);
                const ampm = match[3].toUpperCase();
                
                // Convert to 24-hour format for timestamp calculation
                if (ampm === 'PM' && hours !== 12) hours += 12;
                if (ampm === 'AM' && hours === 12) hours = 0;
                
                return { hours, minutes, ampm, hours12: parseInt(match[1]) };
            }
            
            // Helper function to get times from the schedule display
            function getScheduleTimes(day, isNormal) {
                const times = [];
                const scheduleId = day === 'today' 
                    ? (isNormal ? 'normalDayScheduleToday' : 'workDayScheduleToday')
                    : (isNormal ? 'normalDayScheduleTomorrow' : 'workDayScheduleTomorrow');
                
                const schedule = document.getElementById(scheduleId);
                if (!schedule) return [];
                
                // Find all time containers in the schedule
                const timeElements = schedule.querySelectorAll('.bg-\\[var\\(--tomorrow-accent-bg\\)\\] p, .bg-\\[var\\(--today-accent-bg\\)\\] p');
                
                timeElements.forEach(el => {
                    const timeText = el.textContent.trim();
                    if (timeText.includes(' - ')) {
                        times.push(timeText);
                    }
                });
                
                return times;
            }
            
            function generateDiscordMessage() {
                // Check if elements exist before using them
                if (!useTimestampsToggle || !timestampFormatSelect || !discordTitleInput || !discordMessageOutput || !discordTemplateInput) {
                    console.warn('Discord message generator elements not ready');
                    return;
                }
                
                const useTimestamps = useTimestampsToggle.checked;
                const format = timestampFormatSelect.value;
                const isTodayNormal = !scheduleControls.today.normalSchedule.classList.contains('hidden');
                const isTomorrowNormal = !scheduleControls.tomorrow.normalSchedule.classList.contains('hidden');
                const announcementTitle = discordTitleInput.value;
                const template = discordTemplateInput.value || defaultTemplate;
                
                // Get actual times from the display
                const todayScheduleTimes = getScheduleTimes('today', isTodayNormal);
                const tomorrowScheduleTimes = getScheduleTimes('tomorrow', isTomorrowNormal);
                
                // Format today's times
                let todayTimes = '';
                if (useTimestamps) {
                    todayScheduleTimes.forEach((timeRange, index) => {
                        const [startStr, endStr] = timeRange.split(' - ');
                        const startTime = parseTimeString(startStr);
                        const endTime = parseTimeString(endStr);
                        
                        if (startTime && endTime) {
                            // Check if end time is midnight (12:00 AM)
                            const endDate = (endTime.hours === 0 && endTime.minutes === 0) ? tomorrow : today;
                            
                            if (index > 0) todayTimes += '\n';
                            todayTimes += `- <t:${getTimestamp(today, startTime.hours, startTime.minutes)}:${format}> to <t:${getTimestamp(endDate, endTime.hours, endTime.minutes)}:${format}>`;
                        }
                    });
                } else {
                    todayScheduleTimes.forEach((timeRange, index) => {
                        if (index > 0) todayTimes += '\n';
                        todayTimes += `- ${timeRange}`;
                    });
                }
                
                // Format tomorrow's times
                let tomorrowTimes = '';
                const dayAfterTomorrow = new Date(tomorrow);
                dayAfterTomorrow.setDate(dayAfterTomorrow.getDate() + 1);
                
                if (useTimestamps) {
                    tomorrowScheduleTimes.forEach((timeRange, index) => {
                        const [startStr, endStr] = timeRange.split(' - ');
                        const startTime = parseTimeString(startStr);
                        const endTime = parseTimeString(endStr);
                        
                        if (startTime && endTime) {
                            // Check if end time is midnight (12:00 AM)
                            const endDate = (endTime.hours === 0 && endTime.minutes === 0) ? dayAfterTomorrow : tomorrow;
                            
                            if (index > 0) tomorrowTimes += '\n';
                            tomorrowTimes += `- <t:${getTimestamp(tomorrow, startTime.hours, startTime.minutes)}:${format}> to <t:${getTimestamp(endDate, endTime.hours, endTime.minutes)}:${format}>`;
                        }
                    });
                } else {
                    tomorrowScheduleTimes.forEach((timeRange, index) => {
                        if (index > 0) tomorrowTimes += '\n';
                        tomorrowTimes += `- ${timeRange}`;
                    });
                }
                
                // Dynamic timezone text based on timestamp usage
                // When timestamps are off, use the timezone text from the input field
                const timezoneTextInput = document.getElementById('timezoneTextInput');
                const timezoneInputValue = timezoneTextInput ? timezoneTextInput.value : 'All times are in EST';
                const timezoneText = useTimestamps
                    ? `\`\`Times auto-adjust to your timezone!\`\``
                    : `\`\`${timezoneInputValue}\`\``;
                
                // Get the Twitch link from the input
                const twitchLink = twitchLinkInput ? twitchLinkInput.value : 'https://www.twitch.tv/audaciousgabe';
                
                // Replace placeholders in template
                let message = template
                    .replace(/\[title\]/g, announcementTitle)
                    .replace(/\[today\]/g, todayTimes)
                    .replace(/\[tomorrow\]/g, tomorrowTimes)
                    .replace(/\[timezone\]/g, timezoneText)
                    .replace(/\[link\]/g, twitchLink);

                discordMessageOutput.value = message;
            }

            function setupScheduleToggle(day) {
                const controls = scheduleControls[day];
                controls.normalBtn.addEventListener('click', () => {
                    controls.normalSchedule.classList.remove('hidden');
                    controls.workSchedule.classList.add('hidden');
                    controls.normalBtn.classList.add('active');
                    controls.workBtn.classList.remove('active');
                    generateDiscordMessage();
                });
                controls.workBtn.addEventListener('click', () => {
                    controls.normalSchedule.classList.add('hidden');
                    controls.workSchedule.classList.remove('hidden');
                    controls.workBtn.classList.add('active');
                    controls.normalBtn.classList.remove('active');
                    generateDiscordMessage();
                });
            }
            setupScheduleToggle('today');
            setupScheduleToggle('tomorrow');

            // --- Content Editor Tabs ---
            const editTodayTab = document.getElementById('editTodayTab');
            const editTomorrowTab = document.getElementById('editTomorrowTab');
            const todayEditor = document.getElementById('todayEditor');
            const tomorrowEditor = document.getElementById('tomorrowEditor');

            editTodayTab.addEventListener('click', () => {
                todayEditor.classList.remove('hidden');
                tomorrowEditor.classList.add('hidden');
                editTodayTab.classList.add('active');
                editTomorrowTab.classList.remove('active');
            });

            editTomorrowTab.addEventListener('click', () => {
                todayEditor.classList.add('hidden');
                tomorrowEditor.classList.remove('hidden');
                editTodayTab.classList.remove('active');
                editTomorrowTab.classList.add('active');
            });

            // --- Content Binding ---
            const bindings = [
                // Today
                { inputId: 'todayTitleInput', displayId: 'todayTitle' },
                { inputId: 'todayNormalSlot1TitleInput', displayId: 'todayNormalSlot1Title' },
                { inputId: 'todayNormalSlot1DescInput', displayId: 'todayNormalSlot1Desc' },
                { inputId: 'todayNormalSlot2TitleInput', displayId: 'todayNormalSlot2Title' },
                { inputId: 'todayNormalSlot2DescInput', displayId: 'todayNormalSlot2Desc' },
                { inputId: 'todayNormalSlot3TitleInput', displayId: 'todayNormalSlot3Title' },
                { inputId: 'todayNormalSlot3DescInput', displayId: 'todayNormalSlot3Desc' },
                { inputId: 'todayNormalSlot4TitleInput', displayId: 'todayNormalSlot4Title' },
                { inputId: 'todayNormalSlot4DescInput', displayId: 'todayNormalSlot4Desc' },
                { inputId: 'todayWorkSlot1TitleInput', displayId: 'todayWorkSlot1Title' },
                { inputId: 'todayWorkSlot1DescInput', displayId: 'todayWorkSlot1Desc' },
                { inputId: 'todayWorkSlot2TitleInput', displayId: 'todayWorkSlot2Title' },
                { inputId: 'todayWorkSlot2DescInput', displayId: 'todayWorkSlot2Desc' },
                // Tomorrow
                { inputId: 'tomorrowTitleInput', displayId: 'tomorrowTitle' },
                { inputId: 'tomorrowNormalSlot1TitleInput', displayId: 'tomorrowNormalSlot1Title' },
                { inputId: 'tomorrowNormalSlot1DescInput', displayId: 'tomorrowNormalSlot1Desc' },
                { inputId: 'tomorrowNormalSlot2TitleInput', displayId: 'tomorrowNormalSlot2Title' },
                { inputId: 'tomorrowNormalSlot2DescInput', displayId: 'tomorrowNormalSlot2Desc' },
                { inputId: 'tomorrowNormalSlot3TitleInput', displayId: 'tomorrowNormalSlot3Title' },
                { inputId: 'tomorrowNormalSlot3DescInput', displayId: 'tomorrowNormalSlot3Desc' },
                { inputId: 'tomorrowNormalSlot4TitleInput', displayId: 'tomorrowNormalSlot4Title' },
                { inputId: 'tomorrowNormalSlot4DescInput', displayId: 'tomorrowNormalSlot4Desc' },
                { inputId: 'tomorrowWorkSlot1TitleInput', displayId: 'tomorrowWorkSlot1Title' },
                { inputId: 'tomorrowWorkSlot1DescInput', displayId: 'tomorrowWorkSlot1Desc' },
                { inputId: 'tomorrowWorkSlot2TitleInput', displayId: 'tomorrowWorkSlot2Title' },
                { inputId: 'tomorrowWorkSlot2DescInput', displayId: 'tomorrowWorkSlot2Desc' },
            ];

            function setupBinding({ inputId, displayId }) {
                const inputEl = document.getElementById(inputId);
                const displayEl = document.getElementById(displayId);
                
                // Check if both elements exist before proceeding
                if (!inputEl || !displayEl) {
                    console.warn(`Binding failed: Element not found - inputId: ${inputId}, displayId: ${displayId}`);
                    return;
                }
                
                // Set initial value for the input from the display element
                inputEl.value = displayEl.innerHTML;
                
                // Add event listener to update display on input
                inputEl.addEventListener('input', () => {
                    displayEl.innerHTML = inputEl.value;
                });
            }

            bindings.forEach(setupBinding);

            // --- Global Settings Binding ---
            const channelNameInput = document.getElementById('channelNameInput');
            const channelNameDisplay = document.getElementById('channelNameDisplay');
            const twitchLinkInput = document.getElementById('twitchLinkInput');
            const twitchLinkDisplay = document.getElementById('twitchLinkDisplay');
            const timezoneTextInput = document.getElementById('timezoneTextInput');
            const timezoneTextDisplay = document.getElementById('timezoneTextDisplay');
            
            // Channel name binding
            channelNameInput.addEventListener('input', () => {
                channelNameDisplay.textContent = channelNameInput.value;
            });
            
            // Twitch link binding
            twitchLinkInput.addEventListener('input', () => {
                const url = twitchLinkInput.value;
                twitchLinkDisplay.href = url;
                // Extract username from URL for display text
                const match = url.match(/twitch\.tv\/([^/?]+)/);
                if (match) {
                    twitchLinkDisplay.textContent = `twitch.tv/${match[1]}`;
                } else {
                    twitchLinkDisplay.textContent = url;
                }
            });
            
            // Timezone text binding
            timezoneTextInput.addEventListener('input', () => {
                timezoneTextDisplay.textContent = timezoneTextInput.value;
            });

            // --- Layout Padding Controls ---
            const outerPaddingContainer = document.getElementById('outerPaddingContainer');
            
            const outerSliders = {
                'paddingTop': { input: document.getElementById('outerPaddingTop'), valueSpan: document.getElementById('outerPaddingTopValue'), styleProperty: 'paddingTop' },
                'paddingBottom': { input: document.getElementById('outerPaddingBottom'), valueSpan: document.getElementById('outerPaddingBottomValue'), styleProperty: 'paddingBottom' },
                'paddingLeft': { input: document.getElementById('outerPaddingLeft'), valueSpan: document.getElementById('outerPaddingLeftValue'), styleProperty: 'paddingLeft' },
                'paddingRight': { input: document.getElementById('outerPaddingRight'), valueSpan: document.getElementById('outerPaddingRightValue'), styleProperty: 'paddingRight' }
            };
             const innerSliders = {
                'paddingTop': { input: document.getElementById('innerPaddingTop'), valueSpan: document.getElementById('innerPaddingTopValue'), styleProperty: 'paddingTop' },
                'paddingBottom': { input: document.getElementById('innerPaddingBottom'), valueSpan: document.getElementById('innerPaddingBottomValue'), styleProperty: 'paddingBottom' },
                'paddingLeft': { input: document.getElementById('innerPaddingLeft'), valueSpan: document.getElementById('innerPaddingLeftValue'), styleProperty: 'paddingLeft' },
                'paddingRight': { input: document.getElementById('innerPaddingRight'), valueSpan: document.getElementById('innerPaddingRightValue'), styleProperty: 'paddingRight' }
            };

            function updatePadding(key, sliders, targetElement) {
                const { input, valueSpan, styleProperty } = sliders[key];
                const value = input.value;
                targetElement.style[styleProperty] = `${value}px`;
                valueSpan.textContent = `${value}px`;
            }

            for (const key in outerSliders) {
                updatePadding(key, outerSliders, outerPaddingContainer);
                outerSliders[key].input.addEventListener('input', () => updatePadding(key, outerSliders, outerPaddingContainer));
            }
             for (const key in innerSliders) {
                updatePadding(key, innerSliders, masterPanel);
                innerSliders[key].input.addEventListener('input', () => updatePadding(key, innerSliders, masterPanel));
            }

            // --- Glow Effects Controls ---
            const titleGlowSlider = document.getElementById('titleGlowSize');
            const titleGlowValue = document.getElementById('titleGlowSizeValue');
            const linkGlowSlider = document.getElementById('linkGlowSize');
            const linkGlowValue = document.getElementById('linkGlowSizeValue');
            const panelGlowSlider = document.getElementById('panelGlowSize');
            const panelGlowValue = document.getElementById('panelGlowSizeValue');
            const glowIntensitySlider = document.getElementById('glowIntensity');
            const glowIntensityValue = document.getElementById('glowIntensityValue');
            
            function updateGlowEffects() {
                const titleGlow = titleGlowSlider.value;
                const linkGlow = linkGlowSlider.value;
                const panelGlow = panelGlowSlider.value;
                const intensity = glowIntensitySlider.value / 100;
                
                // Update CSS variables for sizes
                document.documentElement.style.setProperty('--title-glow-size', titleGlow + 'px');
                document.documentElement.style.setProperty('--link-glow-size', linkGlow + 'px');
                document.documentElement.style.setProperty('--panel-glow-size', panelGlow + 'px');
                
                // Get theme colors
                const computedStyles = getComputedStyle(document.body);
                const headerGlow = computedStyles.getPropertyValue('--header-glow').trim();
                const headerGradientStart = computedStyles.getPropertyValue('--header-gradient-start').trim();
                
                // Parse rgba color and apply intensity
                const applyIntensityToRgba = (rgbaString, multiplier = 1) => {
                    const match = rgbaString.match(/rgba?\(([^)]+)\)/);
                    if (match) {
                        const parts = match[1].split(',').map(s => s.trim());
                        if (parts.length >= 3) {
                            const alpha = parts[3] ? parseFloat(parts[3]) : 1;
                            return `rgba(${parts[0]}, ${parts[1]}, ${parts[2]}, ${alpha * intensity * multiplier})`;
                        }
                    }
                    // Fallback for non-rgba colors
                    return `rgba(255, 255, 255, ${0.2 * intensity * multiplier})`;
                };
                
                // Update panel glow colors with intensity applied
                if (headerGlow) {
                    // Use theme's glow color with intensity
                    document.documentElement.style.setProperty('--panel-glow-color', applyIntensityToRgba(headerGlow, 1));
                    document.documentElement.style.setProperty('--panel-glow-color-secondary', applyIntensityToRgba(headerGlow, 0.75));
                    document.documentElement.style.setProperty('--panel-glow-color-tertiary', applyIntensityToRgba(headerGlow, 0.5));
                    document.documentElement.style.setProperty('--panel-glow-color-inset', applyIntensityToRgba(headerGlow, 0.4));
                } else {
                    // Fallback to white glow
                    document.documentElement.style.setProperty('--panel-glow-color', `rgba(255, 255, 255, ${0.2 * intensity})`);
                    document.documentElement.style.setProperty('--panel-glow-color-secondary', `rgba(255, 255, 255, ${0.15 * intensity})`);
                    document.documentElement.style.setProperty('--panel-glow-color-tertiary', `rgba(255, 255, 255, ${0.1 * intensity})`);
                    document.documentElement.style.setProperty('--panel-glow-color-inset', `rgba(255, 255, 255, ${0.08 * intensity})`);
                }
                
                // Update panel border with intensity
                document.documentElement.style.setProperty('--panel-border-color', `rgba(255, 255, 255, ${0.4 * intensity})`);
                
                // Update title glow with intensity
                const titleGlowColor = headerGlow ? applyIntensityToRgba(headerGlow, 1) : `rgba(255, 255, 255, ${0.3 * intensity})`;
                const gradientText = document.querySelector('.gradient-text');
                if (gradientText) {
                    if (intensity > 0) {
                        gradientText.style.textShadow = `0 0 ${titleGlow}px ${titleGlowColor}, 0 0 ${titleGlow}px ${headerGradientStart || '#c084fc'}`;
                    } else {
                        gradientText.style.textShadow = 'none';
                    }
                }
                
                // Update link glow with intensity
                if (twitchLinkDisplay) {
                    const linkColor = computedStyles.getPropertyValue('--today-header').trim();
                    if (intensity > 0) {
                        // Parse link color and apply intensity if it's rgba
                        const linkGlowColor = linkColor.includes('rgba') ? applyIntensityToRgba(linkColor, 1) : linkColor;
                        twitchLinkDisplay.style.textShadow = `0 0 ${linkGlow}px ${linkGlowColor}`;
                        twitchLinkDisplay.style.opacity = 0.8 + (0.2 * intensity); // Adjust link opacity based on intensity
                    } else {
                        twitchLinkDisplay.style.textShadow = 'none';
                        twitchLinkDisplay.style.opacity = 1;
                    }
                }
                
                // Update display values
                titleGlowValue.textContent = titleGlow + 'px';
                linkGlowValue.textContent = linkGlow + 'px';
                panelGlowValue.textContent = panelGlow + 'px';
                glowIntensityValue.textContent = Math.round(intensity * 100) + '%';
            }
            
            // Initialize glow effects
            updateGlowEffects();
            
            // Add event listeners
            titleGlowSlider.addEventListener('input', updateGlowEffects);
            linkGlowSlider.addEventListener('input', updateGlowEffects);
            panelGlowSlider.addEventListener('input', updateGlowEffects);
            glowIntensitySlider.addEventListener('input', updateGlowEffects);

            // --- Discord Message Generator Event Listeners ---
            // (Variables and functions already declared earlier)
            if (useTimestampsToggle) {
                useTimestampsToggle.addEventListener('change', generateDiscordMessage);
            }
            if (timestampFormatSelect) {
                timestampFormatSelect.addEventListener('change', generateDiscordMessage);
            }
            if (discordTitleInput) {
                discordTitleInput.addEventListener('input', generateDiscordMessage);
            }
            if (discordTemplateInput) {
                discordTemplateInput.addEventListener('input', generateDiscordMessage);
            }
            if (resetTemplateBtn) {
                resetTemplateBtn.addEventListener('click', () => {
                    discordTemplateInput.value = defaultTemplate;
                    generateDiscordMessage();
                });
            }

            copyMessageBtn.addEventListener('click', () => {
                discordMessageOutput.select();
                document.execCommand('copy');
                
                const originalText = copyMessageBtn.textContent;
                copyMessageBtn.textContent = 'Copied!';
                setTimeout(() => {
                    copyMessageBtn.textContent = originalText;
                }, 2000);
            });

            // --- Emoji Picker (emoji-picker-element) ---
            const emojiBtn = document.getElementById('emojiBtn');
            const emojiPicker = document.getElementById('emojiPicker');

            // Ensure dark theme for picker to match app theme
            try { emojiPicker.setAttribute('theme', 'dark'); } catch {}

            emojiPicker.addEventListener('emoji-click', (event) => {
                const { unicode } = event.detail || {};
                if (unicode) {
                    discordTitleInput.value += unicode;
                    emojiPicker.style.display = 'none';
                    generateDiscordMessage();
                }
            });

            emojiBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                emojiPicker.style.display = emojiPicker.style.display === 'block' ? 'none' : 'block';
            });

            document.addEventListener('click', (e) => {
                if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) {
                    emojiPicker.style.display = 'none';
                }
            });

            // --- Export as PNG ---
            // const exportBtn = document.getElementById('exportBtn');
            // exportBtn.addEventListener('click', async () => {
            //     const elementToCapture = document.getElementById('outerPaddingContainer');
                
            //     // Store original state
            //     const originalText = exportBtn.textContent;
            //     exportBtn.textContent = 'Generating...';
            //     exportBtn.disabled = true;
                
            //     try {
            //         // Get computed styles for the current theme
            //         const computedStyles = getComputedStyle(document.body);
            //         const bgColor = computedStyles.getPropertyValue('--bg-primary').trim() || '#111827';
                    
            //         // Hide elements that shouldn't be in the export
            //         const elementsToHide = [];
            //         if (!panelScopeToggle.checked) {
            //             const bottomContent = document.getElementById('bottomContent');
            //             if (bottomContent && !bottomContent.classList.contains('hidden')) {
            //                 bottomContent.classList.add('hidden');
            //                 elementsToHide.push(bottomContent);
            //             }
            //         }
                    
            //         // Simple options without complex style processing
            //         const domToImageOptions = {
            //             quality: 1,
            //             bgcolor: bgColor,
            //             width: elementToCapture.offsetWidth,
            //             height: elementToCapture.scrollHeight,
            //             cacheBust: true,
            //             imagePlaceholder: undefined,
            //             filter: (node) => {
            //                 if (!node || !node.tagName) return true;
            //                 if (node.tagName === 'SCRIPT') return false;
            //                 return true;
            //             }
            //         };

            //         // Modern Screenshot options
            //         const modernScreenshotOptions = {
            //             backgroundColor: bgColor,
            //             scale: (window.devicePixelRatio || 2),
            //             filter: (node) => {
            //                 if (!node || !node.tagName) return true;
            //                 if (node.tagName === 'SCRIPT') return false;
            //                 return true;
            //             }
            //         };
                    
            //         // Try Modern Screenshot first, then fall back to dom-to-image-more
            //         let dataUrl;
            //         try {
            //             if (window.modernScreenshot && typeof window.modernScreenshot.domToPng === 'function') {
            //                 dataUrl = await window.modernScreenshot.domToPng(elementToCapture, modernScreenshotOptions);
            //             } else {
            //                 throw new Error('modern-screenshot not available');
            //             }
            //         } catch (msErr) {
            //             console.warn('Modern Screenshot failed, falling back to dom-to-image-more', msErr);
            //             dataUrl = await domtoimage.toPng(elementToCapture, domToImageOptions);
            //         }
                    
            //         // Restore hidden elements
            //         elementsToHide.forEach(el => el.classList.remove('hidden'));
                    
            //         // Create download link
            //         const link = document.createElement('a');
            //         const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            //         link.download = `stream_schedule_${timestamp}.png`;
            //         link.href = dataUrl;
            //         link.click();
                    
            //         // Restore button state
            //         exportBtn.textContent = 'Downloaded!';
            //         setTimeout(() => {
            //             exportBtn.textContent = originalText;
            //             exportBtn.disabled = false;
            //         }, 2000);
                    
            //     } catch (error) {
            //         console.error('Error generating screenshot:', error);
                    
            //         // Restore any hidden elements on error
            //         const bottomContent = document.getElementById('bottomContent');
            //         if (bottomContent && bottomContent.classList.contains('hidden') && panelScopeToggle.checked) {
            //             bottomContent.classList.remove('hidden');
            //         }
                    
            //         exportBtn.textContent = 'Error - Try Again';
            //         exportBtn.disabled = false;
            //         setTimeout(() => {
            //             exportBtn.textContent = originalText;
            //         }, 3000);
            //     }
            // });

            // --- Weekly Planner ---
            const weekDayCardsContainer = document.getElementById('weekDayCards');
            const generateWeeklyBtn = document.getElementById('generateWeeklyScreenshots');
            const previewWeeklyBtn = document.getElementById('previewWeeklySchedule');
            const weeklyModal = document.getElementById('weeklyPlannerModal');
            const closeWeeklyModal = document.getElementById('closeWeeklyModal');
            const weeklyPreviewContainer = document.getElementById('weeklyPreviewContainer');
            const downloadAllWeeklyBtn = document.getElementById('downloadAllWeekly');

            const weekThemeOrder = ['twilight','sunrise','forest','oceanic','cyberpunk','pastel','arctic'];

            function getWeekDates(startDate) {
                return Array.from({ length: 8 }, (_, i) => {
                    const d = new Date(startDate);
                    d.setDate(startDate.getDate() + i);
                    d.setHours(0,0,0,0);
                    return d;
                });
            }
            
            const weekPlan = getWeekDates(today).map(d => ({ date: d, isWork: false }));
            
            function formatLong(d) {
                return d.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
            }
            function formatShort(d) {
                return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            }
            function ymd(d) {
                const y = d.getFullYear();
                const m = String(d.getMonth()+1).padStart(2,'0');
                const day = String(d.getDate()).padStart(2,'0');
                return `${y}-${m}-${day}`;
            }
            function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

            function buildWeekCards() {
                if (!weekDayCardsContainer) return;
                weekDayCardsContainer.innerHTML = '';
                
                // Build cards for all 8 days
                weekPlan.forEach((item, idx) => {
                    const card = document.createElement('div');
                    card.className = 'week-day-card';
                    const label = idx === 0 ? 'Today' : idx === 1 ? 'Tomorrow' : idx === 7 ? 'Day 8 (Reference)' : item.date.toLocaleDateString('en-US', { weekday: 'long' });
                    
                    card.innerHTML = `
                        <div class="flex items-center justify-between mb-3">
                            <span class="day-badge" ${idx === 7 ? 'style="background-color: var(--tomorrow-bg); color: var(--tomorrow-text);"' : ''}>${label}</span>
                            <span class="text-sm text-[var(--text-muted)]">${formatShort(item.date)}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-[var(--text-secondary)]">Normal</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="weekToggle-${idx}" class="sr-only peer" ${item.isWork ? 'checked' : ''}>
                                <div class="w-11 h-6 bg-[var(--btn-inactive-bg)] rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[var(--btn-active-bg)]"></div>
                            </label>
                            <span class="text-sm font-medium text-[var(--text-secondary)]">Work</span>
                        </div>
                    `;
                    
                    weekDayCardsContainer.appendChild(card);
                    const toggle = card.querySelector(`#weekToggle-${idx}`);
                    toggle.addEventListener('change', () => {
                        weekPlan[idx].isWork = toggle.checked;
                    });
                });
                
                // Add the 9th slot for the Day 8 explanation
                const noteCard = document.createElement('div');
                noteCard.className = 'flex items-center justify-center p-4';
                noteCard.innerHTML = `
                    <p class="text-xs text-[var(--text-muted)] text-center italic">
                        Day 8 is used as tomorrow's<br>reference for Day 7's image
                    </p>
                `;
                weekDayCardsContainer.appendChild(noteCard);
            }
            buildWeekCards();

            function setTheme(theme) {
                const baseClasses = 'bg-[var(--bg-primary)] text-[var(--text-primary)] antialiased transition-colors duration-300';
                document.body.className = `${baseClasses} theme-${theme}`;
                // Update active state on theme buttons if visible
                try {
                    const container = document.getElementById('theme-buttons');
                    const currentActive = container.querySelector('.active');
                    if (currentActive) currentActive.classList.remove('active');
                    const newBtn = container.querySelector(`[data-theme="${theme}"]`);
                    if (newBtn) newBtn.classList.add('active');
                } catch {}
            }

            function setTodaySchedule(isWork) {
                // Use existing button handlers to keep UI in sync
                if (isWork) {
                    scheduleControls.today.workBtn.click();
                } else {
                    scheduleControls.today.normalBtn.click();
                }
            }

            function setTodayHeaderForDate(d) {
                const dayName = d.toLocaleDateString('en-US', { weekday: 'long' });
                const md = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                todayTitleEl.innerHTML = `${dayName}'s Stream &bull; ${md}`;
            }

            async function captureCurrentPanel(pixelRatio = 3) {
                // Hide transient UI (emoji picker) during capture
                try { document.getElementById('emojiPicker').style.display = 'none'; } catch {}
                const elementToCapture = document.getElementById('outerPaddingContainer');
                const bgVar = getComputedStyle(document.body).getPropertyValue('--bg-primary').trim();
                const backgroundColor = bgVar || '#111827';
                let dataUrl;
                // Let layout settle
                await sleep(50);
                try {
                    if (window.htmlToImage && typeof window.htmlToImage.toPng === 'function') {
                        dataUrl = await window.htmlToImage.toPng(elementToCapture, {
                            pixelRatio,
                            cacheBust: true,
                            backgroundColor,
                            filter: (node) => {
                                if (!node || !node.tagName) return true;
                                if (node.id === 'weeklyPlannerModal') return false; // exclude modal if open
                                if (node.tagName === 'SCRIPT') return false;
                                return true;
                            }
                        });
                    }
                } catch {}
                if (!dataUrl) {
                    try {
                        if (window.modernScreenshot && typeof window.modernScreenshot.domToPng === 'function') {
                            dataUrl = await window.modernScreenshot.domToPng(elementToCapture, {
                                backgroundColor,
                                scale: (window.devicePixelRatio || 2)
                            });
                        } else {
                            throw new Error('modern-screenshot not available');
                        }
                    } catch (msErr) {
                        try {
                            dataUrl = await domtoimage.toPng(elementToCapture, {
                                bgcolor: backgroundColor,
                                width: elementToCapture.offsetWidth,
                                height: elementToCapture.scrollHeight,
                                cacheBust: true,
                                imagePlaceholder: undefined,
                                filter: (node) => {
                                    if (!node || !node.tagName) return true;
                                    if (node.id === 'weeklyPlannerModal') return false;
                                    if (node.tagName === 'SCRIPT') return false;
                                    return true;
                                }
                            });
                        } catch (dtiErr) {
                            console.error('Weekly export failed', msErr, dtiErr);
                            throw dtiErr;
                        }
                    }
                }
                return dataUrl;
            }

            async function generateWeekImages(options = { pixelRatio: 3 }) {
                const { pixelRatio } = options;
                // Show overlay to prevent flashing
                const overlay = document.getElementById('screenshotOverlay');
                const overlayTitle = document.getElementById('overlayTitle');
                const overlayMessage = document.getElementById('overlayMessage');
                
                if (overlay) {
                    overlay.style.display = 'block';
                    // Force reflow to ensure display:block is applied before opacity transition
                    overlay.offsetHeight;
                    overlay.style.opacity = '1';
                    overlayTitle.textContent = 'Generating Screenshots';
                    overlayMessage.textContent = 'Preparing...';
                    // Wait for overlay to fully appear
                    await sleep(350);
                }
                
                // Preserve original state including the current theme
                const originalTodayTitle = todayTitleEl.innerHTML;
                const originalTomorrowTitle = tomorrowTitleEl.innerHTML;
                const originalBodyClass = document.body.className;
                const originalPanelScopeChecked = panelScopeToggle.checked;
                const originalIsWork = !scheduleControls.today.workSchedule.classList.contains('hidden'); // work shown means true
                
                // Extract the original theme from body class
                const themeMatch = originalBodyClass.match(/theme-(\w+)/);
                const originalTheme = themeMatch ? themeMatch[1] : 'twilight'

                // Don't force Today Only scope - respect user's current setting
                // This allows the weekly planner to honor the Export Scope toggle

                const results = [];
                // Store original tomorrow schedule state
                const originalTomorrowIsWork = !scheduleControls.tomorrow.workSchedule.classList.contains('hidden');
                
                // Generate images for first 7 days only
                for (let i = 0; i < 7; i++) {
                    const { date, isWork } = weekPlan[i];
                    const theme = weekThemeOrder[i % weekThemeOrder.length];
                    
                    // Update overlay progress
                    if (overlayMessage && overlay && overlay.style.display !== 'none') {
                        const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
                        overlayMessage.textContent = `Processing ${dayName} (${i+1}/7)`;
                    }

                    // Apply theme and schedule for today
                    setTheme(theme);
                    setTodaySchedule(isWork);
                    setTodayHeaderForDate(date);
                    
                    // Set up tomorrow's schedule for all days (using the next day's settings)
                    // Only if we're in Full Schedule mode (panel scope is checked)
                    if (panelScopeToggle.checked && i < weekPlan.length - 1) {
                        const nextDay = weekPlan[i + 1];
                        
                        // Set tomorrow's schedule type based on next day
                        if (nextDay.isWork) {
                            scheduleControls.tomorrow.workBtn.click();
                        } else {
                            scheduleControls.tomorrow.normalBtn.click();
                        }
                        
                        // Set tomorrow's title to show next day's date
                        const nextDayName = nextDay.date.toLocaleDateString('en-US', { weekday: 'long' });
                        const nextDayMD = nextDay.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        tomorrowTitleEl.innerHTML = `Tomorrow's Stream &bull; ${nextDayMD}`;
                    }

                    // Capture
                    const dataUrl = await captureCurrentPanel(pixelRatio);
                    const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                    const fileName = `schedule_${ymd(date)}_${dayName.toLowerCase()}_${theme}_${isWork ? 'work' : 'normal'}.png`;
                    results.push({ name: fileName, dataUrl });
                }

                // Restore state
                todayTitleEl.innerHTML = originalTodayTitle;
                tomorrowTitleEl.innerHTML = originalTomorrowTitle;
                document.body.className = originalBodyClass;
                setTodaySchedule(originalIsWork);
                
                // Restore tomorrow's schedule state
                if (originalTomorrowIsWork) {
                    scheduleControls.tomorrow.workBtn.click();
                } else {
                    scheduleControls.tomorrow.normalBtn.click();
                }
                
                if (panelScopeToggle.checked !== originalPanelScopeChecked) {
                    panelScopeToggle.checked = originalPanelScopeChecked;
                    panelScopeToggle.dispatchEvent(new Event('change'));
                }
                
                // Restore the original theme and update button highlights
                setTheme(originalTheme);
                updateGlowEffects(); // Restore glow effects for the original theme
                
                // Hide overlay with fade out
                if (overlay) {
                    overlayMessage.textContent = 'Complete!';
                    await sleep(500);
                    overlay.style.opacity = '0';
                    setTimeout(() => {
                        overlay.style.display = 'none';
                    }, 300);
                }

                return results;
            }

            if (generateWeeklyBtn) {
                generateWeeklyBtn.addEventListener('click', async () => {
                    try {
                        generateWeeklyBtn.disabled = true;
                        generateWeeklyBtn.textContent = 'Generating...';
                        
                        // Generate images (overlay handled inside)
                        const images = await generateWeekImages({ pixelRatio: 3 });
                        
                        // Update overlay for ZIP creation
                        const overlayMessage = document.getElementById('overlayMessage');
                        if (overlayMessage) {
                            overlayMessage.textContent = 'Creating ZIP archive...';
                        }
                        
                        // Create and download ZIP
                        if (!window.JSZip) throw new Error('JSZip not loaded');
                        const zip = new JSZip();
                        images.forEach(img => {
                            const base64 = img.dataUrl.split(',')[1];
                            zip.file(img.name, base64, { base64: true });
                        });
                        const blob = await zip.generateAsync({ type: 'blob' });
                        
                        if (window.saveAs) {
                            window.saveAs(blob, `weekly_schedules_${ymd(new Date())}.zip`);
                        } else {
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `weekly_schedules_${ymd(new Date())}.zip`;
                            a.click();
                            URL.revokeObjectURL(url);
                        }
                        
                        generateWeeklyBtn.textContent = 'Downloaded!';
                        setTimeout(() => {
                            generateWeeklyBtn.textContent = 'üìÖ Generate Week Screenshots';
                            generateWeeklyBtn.disabled = false;
                        }, 1200);
                    } catch (e) {
                        console.error(e);
                        generateWeeklyBtn.textContent = 'Error - Try Again';
                        setTimeout(() => {
                            generateWeeklyBtn.textContent = 'üìÖ Generate Week Screenshots';
                            generateWeeklyBtn.disabled = false;
                        }, 2000);
                    }
                });
            }

            if (previewWeeklyBtn) {
                previewWeeklyBtn.addEventListener('click', async () => {
                    try {
                        // Show overlay for preview generation
                        const overlay = document.getElementById('screenshotOverlay');
                        const overlayTitle = document.getElementById('overlayTitle');
                        const overlayMessage = document.getElementById('overlayMessage');
                        
                        if (overlay) {
                            overlay.style.display = 'block';
                            overlay.offsetHeight;
                            overlay.style.opacity = '1';
                            overlayTitle.textContent = 'Generating Previews';
                            overlayMessage.textContent = 'Preparing preview images...';
                            await sleep(350);
                        }
                        
                        previewWeeklyBtn.disabled = true;
                        previewWeeklyBtn.textContent = 'Generating Previews...';
                        const images = await generateWeekImages({ pixelRatio: 1.5 });
                        weeklyPreviewContainer.innerHTML = '';
                        images.forEach((img, i) => {
                            const wrap = document.createElement('div');
                            wrap.className = 'screenshot-preview';
                            const meta = document.createElement('div');
                            meta.className = 'px-3 py-2 text-sm text-[var(--text-secondary)] flex items-center justify-between bg-[var(--bg-secondary)] border-b border-[var(--border-primary)]';
                            const [ , ymdPart, dayPart, theme, mode ] = img.name.replace('.png','').split('_');
                            meta.textContent = `${ymdPart} ‚Ä¢ ${dayPart.toUpperCase()} ‚Ä¢ ${theme} ‚Ä¢ ${mode}`;
                            const imageEl = document.createElement('img');
                            imageEl.src = img.dataUrl;
                            imageEl.alt = img.name;
                            imageEl.style.width = '100%';
                            wrap.appendChild(meta);
                            wrap.appendChild(imageEl);
                            weeklyPreviewContainer.appendChild(wrap);
                        });
                        // Hide overlay before showing modal
                        if (overlay) {
                            overlayMessage.textContent = 'Complete!';
                            await sleep(300);
                            overlay.style.opacity = '0';
                            setTimeout(() => {
                                overlay.style.display = 'none';
                            }, 300);
                            // Small delay to ensure overlay is hidden before modal appears
                            await sleep(350);
                        }
                        
                        weeklyModal.style.display = 'block';
                    } catch (e) {
                        console.error(e);
                        // Hide overlay on error
                        const overlay = document.getElementById('screenshotOverlay');
                        if (overlay && overlay.style.display !== 'none') {
                            overlay.style.opacity = '0';
                            setTimeout(() => {
                                overlay.style.display = 'none';
                            }, 300);
                        }
                    } finally {
                        previewWeeklyBtn.textContent = 'üëÅÔ∏è Preview All Days';
                        previewWeeklyBtn.disabled = false;
                    }
                });
            }
            if (closeWeeklyModal) {
                closeWeeklyModal.addEventListener('click', () => { weeklyModal.style.display = 'none'; });
            }
            if (downloadAllWeeklyBtn) {
                downloadAllWeeklyBtn.addEventListener('click', async () => {
                    try {
                        // Show overlay for ZIP generation
                        const overlay = document.getElementById('screenshotOverlay');
                        const overlayTitle = document.getElementById('overlayTitle');
                        const overlayMessage = document.getElementById('overlayMessage');
                        
                        if (overlay) {
                            overlay.style.display = 'block';
                            overlay.offsetHeight;
                            overlay.style.opacity = '1';
                            overlayTitle.textContent = 'Creating ZIP Archive';
                            overlayMessage.textContent = 'Generating screenshots...';
                            await sleep(350);
                        }
                        
                        downloadAllWeeklyBtn.disabled = true;
                        downloadAllWeeklyBtn.textContent = 'Zipping...';
                        const images = await generateWeekImages({ pixelRatio: 3 });
                        if (overlayMessage) {
                            overlayMessage.textContent = 'Creating ZIP archive...';
                        }
                        
                        if (!window.JSZip) throw new Error('JSZip not loaded');
                        const zip = new JSZip();
                        images.forEach(img => {
                            const base64 = img.dataUrl.split(',')[1];
                            zip.file(img.name, base64, { base64: true });
                        });
                        const blob = await zip.generateAsync({ type: 'blob' });
                        if (window.saveAs) {
                            window.saveAs(blob, `weekly_schedules_${ymd(new Date())}.zip`);
                        } else {
                            // Fallback: trigger download via object URL
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `weekly_schedules_${ymd(new Date())}.zip`;
                            a.click();
                            URL.revokeObjectURL(url);
                        }
                        
                        // Hide overlay
                        if (overlay) {
                            overlayMessage.textContent = 'Complete!';
                            await sleep(500);
                            overlay.style.opacity = '0';
                            setTimeout(() => {
                                overlay.style.display = 'none';
                            }, 300);
                        }
                        
                        downloadAllWeeklyBtn.textContent = 'Downloaded!';
                        setTimeout(() => { downloadAllWeeklyBtn.textContent = 'üíæ Download All as ZIP'; downloadAllWeeklyBtn.disabled = false; }, 1200);
                    } catch (e) {
                        console.error(e);
                        downloadAllWeeklyBtn.textContent = 'Error - Try Again';
                        setTimeout(() => { downloadAllWeeklyBtn.textContent = 'üíæ Download All as ZIP'; downloadAllWeeklyBtn.disabled = false; }, 2000);
                    }
                });
            }

            // --- Save All Settings Button ---
            const saveAllSettingsBtn = document.getElementById('saveAllSettingsBtn');
            const saveStatusMessage = document.getElementById('saveStatusMessage');
            
            if (saveAllSettingsBtn) {
                saveAllSettingsBtn.addEventListener('click', async () => {
                    // Gather all settings
                    const configToSave = {
                        // Theme
                        theme: document.querySelector('.theme-btn.active')?.dataset.theme || 'twilight',
                        
                        // Channel info
                        channel: {
                            name: channelNameInput.value,
                            link: twitchLinkInput.value
                        },
                        
                        // Titles
                        todayTitle: document.getElementById('todayTitleInput')?.value,
                        tomorrowTitle: document.getElementById('tomorrowTitleInput')?.value,
                        
                        // Timezone
                        timezoneText: timezoneTextInput.value,
                        
                        // Layout settings
                        layout: {
                            outerPadding: {
                                top: parseInt(outerSliders.paddingTop.input.value),
                                bottom: parseInt(outerSliders.paddingBottom.input.value),
                                left: parseInt(outerSliders.paddingLeft.input.value),
                                right: parseInt(outerSliders.paddingRight.input.value)
                            },
                            innerPadding: {
                                top: parseInt(innerSliders.paddingTop.input.value),
                                bottom: parseInt(innerSliders.paddingBottom.input.value),
                                left: parseInt(innerSliders.paddingLeft.input.value),
                                right: parseInt(innerSliders.paddingRight.input.value)
                            }
                        },
                        
                        // Glow effects
                        glowEffects: {
                            titleGlowSize: parseInt(titleGlowSlider.value),
                            linkGlowSize: parseInt(linkGlowSlider.value),
                            panelGlowSize: parseInt(panelGlowSlider.value),
                            glowIntensity: parseInt(glowIntensitySlider.value)
                        },
                        
                        // Schedule types
                        schedule: {
                            today: {
                                type: scheduleControls.today.normalBtn.classList.contains('active') ? 'normal' : 'work'
                            },
                            tomorrow: {
                                type: scheduleControls.tomorrow.normalBtn.classList.contains('active') ? 'normal' : 'work'
                            }
                        },
                        
                        // Export scope
                        exportScope: panelScopeToggle.checked ? 'full' : 'today',
                        
                        // Discord message generator settings
                        discord: {
                            title: discordTitleInput.value,
                            template: discordTemplateInput.value,
                            useTimestamps: useTimestampsToggle.checked,
                            timestampFormat: timestampFormatSelect.value
                        }
                    };
                    
                    // Save to server
                    saveAllSettingsBtn.disabled = true;
                    saveAllSettingsBtn.textContent = 'Saving...';
                    
                    try {
                        await saveConfigToServer(configToSave);
                        
                        // Show success message
                        saveAllSettingsBtn.textContent = '‚úÖ Saved!';
                        saveStatusMessage.textContent = 'All settings saved successfully';
                        saveStatusMessage.classList.remove('hidden');
                        saveStatusMessage.style.color = 'var(--today-accent)';
                        
                        setTimeout(() => {
                            saveAllSettingsBtn.textContent = 'üíæ Save All Settings';
                            saveAllSettingsBtn.disabled = false;
                            saveStatusMessage.classList.add('hidden');
                        }, 2000);
                    } catch (error) {
                        // Show error message
                        saveAllSettingsBtn.textContent = '‚ùå Error';
                        saveStatusMessage.textContent = 'Failed to save settings';
                        saveStatusMessage.classList.remove('hidden');
                        saveStatusMessage.style.color = 'var(--tomorrow-header)';
                        
                        setTimeout(() => {
                            saveAllSettingsBtn.textContent = 'üíæ Save All Settings';
                            saveAllSettingsBtn.disabled = false;
                            saveStatusMessage.classList.add('hidden');
                        }, 3000);
                    }
                });
            }
            
            // Initial generation
            generateDiscordMessage();
            
            // Add global function to regenerate Discord message (for editor-slots.js to call)
            window.regenerateDiscordMessage = generateDiscordMessage;
        });
    </script>
<script src="https://cdn.jsdelivr.net/npm/html-to-image@1.11.11/dist/html-to-image.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script>
    document.getElementById('exportBtn').addEventListener('click', async function () {
        const exportBtn = this;
        // Ensure fonts are loaded for correct metrics
        if (document.fonts && document.fonts.ready) {
            try { await document.fonts.ready; } catch {}
        }
        const elementToCapture = document.getElementById('outerPaddingContainer');
        const bgVar = getComputedStyle(document.body).getPropertyValue('--bg-primary').trim();
        const backgroundColor = bgVar || '#111827';
        const elementsToHide = [];

        // Reflect current panel scope (hide bottomContent if Today Only)
        try {
            const panelScopeToggle = document.getElementById('panelScopeToggle');
            if (panelScopeToggle && !panelScopeToggle.checked) {
                const bottomContent = document.getElementById('bottomContent');
                if (bottomContent && !bottomContent.classList.contains('hidden')) {
                    bottomContent.classList.add('hidden');
                    elementsToHide.push(bottomContent);
                }
            }
        } catch {}

        // Disable button during export
        const originalText = exportBtn.textContent;
        exportBtn.textContent = 'Generating...';
        exportBtn.disabled = true;

        // Export-only: remove backdrop filters and flatten semi-transparent backgrounds/borders
        const modified = [];
        const parseColor = (str) => {
            if (!str) return null; const m = str.match(/rgba?\(([^)]+)\)/); if (m){ const p=m[1].split(',').map(s=>parseFloat(s)); return {r:p[0],g:p[1],b:p[2],a:p[3]??1};}
            if (/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(str)){ let hex=str.slice(1); if(hex.length===3){hex=hex.split('').map(c=>c+c).join('');} return {r:parseInt(hex.slice(0,2),16),g:parseInt(hex.slice(2,4),16),b:parseInt(hex.slice(4,6),16),a:1}; }
            return null;
        };
        const toHex = ({r,g,b}) => `#${[r,g,b].map(n=>Math.round(n).toString(16).padStart(2,'0')).join('')}`;
        const blend = (fg, bg) => { const a=fg.a+bg.a*(1-fg.a); return { r:(fg.r*fg.a+bg.r*bg.a*(1-fg.a))/a, g:(fg.g*fg.a+bg.g*bg.a*(1-fg.a))/a, b:(fg.b*fg.a+bg.b*bg.a*(1-fg.a))/a, a}; };
        const base = parseColor(backgroundColor) || {r:17,g:24,b:39,a:1};
        const getNearestSolidBg = (el) => {
            let cur = el;
            while (cur && cur !== elementToCapture.parentElement) {
                const cs = getComputedStyle(cur);
                const bgc = parseColor(cs.backgroundColor);
                if (bgc && bgc.a > 0) return bgc;
                cur = cur.parentElement;
            }
            return base;
        };
        elementToCapture.querySelectorAll('*').forEach(el => {
            const cs = getComputedStyle(el);
            if ((cs.backdropFilter && cs.backdropFilter!=='none') || (cs.webkitBackdropFilter && cs.webkitBackdropFilter!=='none')){
                modified.push({el, prop:'backdropFilter', prev: el.style.backdropFilter});
                modified.push({el, prop:'webkitBackdropFilter', prev: el.style.webkitBackdropFilter});
                el.style.backdropFilter='none'; el.style.webkitBackdropFilter='none';
            }
            const bgc = parseColor(cs.backgroundColor);
            if (bgc && bgc.a<1){
                const under = getNearestSolidBg(el.parentElement || elementToCapture);
                const blended = blend(bgc, under);
                modified.push({el, prop:'backgroundColor', prev: el.style.backgroundColor});
                el.style.backgroundColor = toHex(blended);
            }
            // Flatten semi-transparent border colors on all sides
            const sides = ['Top','Right','Bottom','Left'];
            const anyBorder = sides.some(s => cs[`border${s}Width`] && cs[`border${s}Width`] !== '0px');
            if (anyBorder) {
                const under = getNearestSolidBg(el.parentElement || elementToCapture);
                sides.forEach(side => {
                    const col = parseColor(cs[`border${side}Color`]);
                    const w = cs[`border${side}Width`];
                    if (w && w !== '0px' && col && col.a < 1) {
                        const blended = blend(col, under);
                        const hex = toHex(blended);
                        const prop = `border${side}Color`;
                        modified.push({el, prop, prev: el.style[prop]});
                        el.style[prop] = hex;
                    }
                });
            }
            // Temporarily hide outlines if any
            if (cs.outlineStyle && cs.outlineStyle !== 'none') {
                modified.push({el, prop:'outline', prev: el.style.outline});
                el.style.outline = 'none';
            }
        });

        let dataUrl;
        try {
            // Try html-to-image first
            if (window.htmlToImage && typeof window.htmlToImage.toPng === 'function') {
                try {
                    dataUrl = await window.htmlToImage.toPng(elementToCapture, {
                        pixelRatio: 3,
                        cacheBust: true,
                        backgroundColor,
                        filter: (node) => {
                            if (!node || !node.tagName) return true;
                            if (node.tagName === 'SCRIPT') return false;
                            return true;
                        }
                    });
                } catch (e) {
                    // continue to other methods
                }
            }

            // Then try modern-screenshot
            if (!dataUrl) {
                try {
                    if (window.modernScreenshot && typeof window.modernScreenshot.domToPng === 'function') {
                        dataUrl = await window.modernScreenshot.domToPng(elementToCapture, {
                            backgroundColor,
                            scale: (window.devicePixelRatio || 2)
                        });
                    } else {
                        throw new Error('modern-screenshot not available');
                    }
                } catch (msErr) {
                    // Fallback to dom-to-image-more
                    try {
                        dataUrl = await domtoimage.toPng(elementToCapture, {
                            bgcolor: backgroundColor,
                            width: elementToCapture.offsetWidth,
                            height: elementToCapture.scrollHeight,
                            cacheBust: true,
                            imagePlaceholder: undefined,
                            filter: (node) => {
                                if (!node || !node.tagName) return true;
                                if (node.tagName === 'SCRIPT') return false;
                                return true;
                            }
                        });
                    } catch (dtiErr) {
                        console.error('Export failed', msErr, dtiErr);
                        throw dtiErr;
                    }
                }
            }

            const link = document.createElement('a');
            link.download = `stream_schedule_${new Date().toISOString().replace(/[:.]/g, '-')}.png`;
            link.href = dataUrl;
            link.click();
            exportBtn.textContent = 'Downloaded!';
            setTimeout(() => { exportBtn.textContent = originalText; exportBtn.disabled = false; }, 1500);
        } catch (err) {
            exportBtn.textContent = 'Error - Try Again';
            setTimeout(() => { exportBtn.textContent = originalText; exportBtn.disabled = false; }, 2000);
        } finally {
            // Restore styles and hidden elements
            modified.forEach(({el, prop, prev}) => { el.style[prop] = prev; });
            elementsToHide.forEach(el => el.classList.remove('hidden'));
            if (!exportBtn.disabled) exportBtn.disabled = false;
        }
    });
</script>
</body>
</html>